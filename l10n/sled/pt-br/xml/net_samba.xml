<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_samba.xml" version="5.0" xml:id="cha-samba">
 <title>Samba</title>
 <info>
  <abstract>
   <para>
    Com o Samba, uma máquina Unix pode ser configurada como um servidor de arquivos e de impressão em máquinas macOS, Windows e OS/2. O Samba se tornou um produto completo e bastante complexo. Configure o Samba com o YaST ou editando o arquivo de configuração manualmente.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-samba-term">
  <title>Terminologia</title>

  <para>
   A seguir são apresentados alguns termos usados na documentação do Samba e no módulo YaST.
  </para>

  <variablelist>
   <varlistentry>
    <term>Protocolo SMB</term>
    <listitem>
     <para>
      O Samba usa o protocolo SMB (bloco de mensagens do servidor), que é baseado nos serviços <phrase role="productname">NetBIOS</phrase>. A Microsoft lançou o protocolo para que outros fabricantes de software pudessem estabelecer conexões com uma rede de domínio Microsoft. Com o Samba, o protocolo SMB opera acima do protocolo TCP/IP, de modo que este último precisa estar instalado em todos os clientes.
     </para>
     
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Protocolo CIFS</term>
    <listitem>
     <para>
      O protocolo CIFS (sistema de arquivos da Internet comuns) é outro protocolo com suporte do Samba. O CIFS é um protocolo de acesso padrão a sistemas de arquivos remotos para utilização pela rede, permitindo que grupos de usuários trabalhem juntos e compartilhem documentos pela rede.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS</term>
    <listitem>
     <para>
        NetBIOS é uma interface de software (API) projetada para a comunicação entre máquinas que fornecem serviço de nomes. Ele permite que máquinas conectadas à rede reservem nomes para si. Após a reserva, essas máquinas podem ser tratadas pelo nome. Não há um processo central para a verificação de nomes. Qualquer máquina da rede pode reservar quantos nomes quiser, contanto que os nomes não estejam em uso ainda. A interface NetBIOS pode ser implementada para diferentes arquiteturas de rede. Uma implementação que funciona com relativa proximidade com o hardware da rede é chamada de <phrase role="productname">NetBEUI</phrase>, mas ela muitas vezes é chamada de <phrase role="productname">NetBIOS</phrase>. Os protocolos de rede implementados com o NetBIOS são o IPX da Novell (NetBIOS via TCP/IP) e TCP/IP.
     </para>
     <para>
      Os nomes de NetBIOS enviados por TCP/IP não possuem nada em comum com os nomes usados em <filename>/etc/hosts</filename> ou com os nomes definidos pelo DNS. O NetBIOS usa sua própria convenção de nomes independente. Contudo, é recomendável usar nomes que correspondam aos nomes de host DNS para facilitar a administração ou usar o DNS nativamente. Esse é o padrão usado pelo Samba.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Servidor Samba</term>
    <listitem>
     <para>
      O servidor Samba fornece serviços SMB/CIFS e serviços de nomeação NetBIOS por IP aos clientes. Para o Linux, existem três daemons para servidor Samba: smbd para serviços SMB/CIFS, nmbd para serviços de nomeação e winbind para autenticação.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Cliente Samba</term>
    <listitem>
     <para>
      O cliente Samba é um sistema que usa serviços Samba de um servidor Samba pelo protocolo SMB. Sistemas operacionais comuns, como Windows e macOS, suportam o protocolo SMB. O protocolo TCP/IP precisa estar instalado em todos os computadores. O Samba oferece um cliente para as diferentes versões do Unix. No caso do Linux, há um módulo de kernel para SMB que permite a integração de recursos SMB no nível de sistema Linux. Não é necessário executar nenhum daemon para o cliente Samba.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Compartilhamentos</term>
    <listitem>
     <para>
      Os servidores SMB oferecem recursos aos clientes por meio de compartilhamentos. Compartilhamentos são impressoras e diretórios com seus subdiretórios no servidor. Ele é exportado por meio de um nome e pode ser acessado pelo nome. O nome do compartilhamento pode ser definido como qualquer nome, não precisa ser o nome do diretório de exportação. Uma impressora também recebe um nome. Os clientes podem acessar a impressora pelo nome dela.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
      Um controlador de domínio (DC) é um servidor que gerencia contas em um domínio. Para a replicação de dados, os controladores de domínio adicionais estão disponíveis em um domínio.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-samba-server-sled" os="sled">
  <title>Instalando um servidor Samba</title>
  <para>
   A instalação de um servidor Samba não é suportada no SUSE Linux Enterprise Desktop. Para obter informações sobre como instalar e configurar um servidor Samba, consulte o <citetitle>Guia de Administração</citetitle> para SUSE Linux Enterprise Server.
  </para>
 </sect1>
 
 
 
 <sect1 xml:id="sec-samba-client-inst">
  <title>Configurando clientes</title>

  <para>
   Os clientes somente podem acessar o servidor Samba via TCP/IP. O NetBEUI e o NetBIOS via IPX não podem ser usados com o Samba.
  </para>

  <sect2 xml:id="sec-samba-client-inst-yast">
   <title>Configurando um cliente Samba com o YaST</title>
   <para>
    Configure um cliente Samba para acessar recursos (arquivos ou impressoras) no servidor Samba ou Windows. Digite o domínio NT ou Active Directory ou o grupo de trabalho na caixa de diálogo <menuchoice> <guimenu>Serviços de Rede</guimenu> <guimenu>Participação no Domínio do Windows</guimenu></menuchoice>. Se você ativar <guimenu>Também Usar Informação SMB para Autenticação Linux</guimenu>, a autenticação do usuário será executada no servidor Samba, NT ou Kerberos.
   </para>
   <para>
    Clique em <guimenu>Configurações de Especialista</guimenu> para ver as opções de configuração avançadas. Por exemplo, use a tabela <guimenu>Montar Diretórios do Servidor</guimenu> para habilitar a montagem de diretório pessoal do servidor automaticamente com autenticação. Dessa forma, os usuários podem acessar seus diretórios pessoais quando estão hospedados no CIFS. Para ver os detalhes, consulte a página de manual de <systemitem>pam_mount</systemitem>.
   </para>
   <para>
    Após concluir todas as configurações, confirme a caixa de diálogo para terminar a configuração.
   </para>
  </sect2>
  <sect2 xml:id="sec-samba-client-old-server">
   <title>Montando compartilhamentos SMB1 em clientes</title>
   <para>
    A primeira versão do protocolo de rede SMB, SMB1, é um protocolo antigo e não seguro que foi descontinuado por seu originador, Microsoft. Por motivos de segurança, o comando <command>mount</command> no <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> montará apenas compartilhamentos SMB usando versões de protocolo mais recentes por padrão, especificamente SMB 2.1, SMB 3.0 ou SMB 3.02.
   </para>
   <para>
    No entanto, essa mudança afeta apenas o <command>mount</command> e a montagem por <filename>/etc/fstab</filename>. Por padrão, o SMB1 ainda está disponível ao usar o seguinte:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      A ferramenta <command>smbclient</command>.
     </para>
    </listitem>
    <listitem>
     <para>
      O software do servidor Samba já vem com o <phrase os="sles;sled">SUSE Linux Enterprise Server</phrase>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Há configurações em que essa definição padrão resultará em falhas de conexão, já que apenas o SMB1 pode ser usado:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Configurações que usam um servidor SMB sem suporte para versões de protocolo SMB mais recentes. O Windows tem oferecido suporte ao SMB 2.1 desde o Windows 7 e o Windows Server 2008.
     </para>
    </listitem>
    <listitem>
     <para>
      Configurações que usam extensões Unix do SMB1/CIFS. Essas extensões não foram portadas para as versões de protocolo mais recentes.
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>Segurança do sistema reduzida</title>
    <para>
     Siga a instrução a seguir para possibilitar a exploração de problemas de segurança. Para obter mais informações sobre os problemas, consulte <link xlink:href="https://blogs.technet.microsoft.com/filecab/2016/09/16/stop-using-smb1/"/>.
    </para>
    <para>
     Assim que possível, faça upgrade do servidor para permitir uma versão mais segura do SMB.
    </para>
    
   </important>
   <para>
    Se for necessário habilitar compartilhamentos SMB1 no kernel do <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> atual, adicione a opção <option>vers=1.0</option> à linha de comando <command>mount</command> que você usa:
   </para>
   <screen><prompt role="root">root # </prompt>mount –t smbfs <replaceable>IP_ADDRESS</replaceable>:/<replaceable>SHARE</replaceable> /<replaceable>MOUNT_POINT</replaceable> –o username=<replaceable>USER_ID</replaceable>,workgroup=<replaceable>WORKGROUP_NAME</replaceable>,<emphasis role="bold">vers=1.0</emphasis></screen>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-anmeld-serv">
  <title>Samba como servidor de login</title>

  <para>
   Nas configurações da empresa, a preferência costuma ser em permitir acesso apenas a usuários registrados em uma instância central. Em uma rede baseada no Windows, essa tarefa é gerenciada por um PDC (primary domain controller — controlador de domínio primário). Você pode usar um servidor Windows NT configurado como PDC, mas essa tarefa também pode ser executada com um servidor Samba. As entradas a serem feitas na seção <literal>[global]</literal> de <filename>smb.conf</filename> aparecem em <xref linkend="dat-samba-smb-conf-dom"/>.
  </para>

  <example xml:id="dat-samba-smb-conf-dom">
   <title>Seção global em smb.conf</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   É necessário preparar contas e senhas de usuários em formato de criptografia compatível com o Windows. Para isso, use o comando <command>smbpasswd</command> <option>-a name</option>. Crie a conta de domínio dos computadores, exigida pelo conceito de domínio do Windows , com os seguintes comandos:
  </para>

<screen>useradd hostname
smbpasswd -a -m hostname</screen>

  <para>
   Com o comando <command>useradd</command>, um símbolo de cifrão é adicionado. O comando <command>smbpasswd</command> insere esse símbolo automaticamente quando o parâmetro <option>-m</option> é usado. O exemplo de configuração comentado (<filename>/usr/share/doc/packages/samba/examples/smb.conf.SUSE</filename>) contém configurações que automatizam essa tarefa.
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m
     </screen>

  <para>
   Para certificar-se de que o Samba possa executar esse script corretamente, escolha um usuário do Samba com as permissões de administrador necessárias e adicione-o ao grupo <systemitem class="groupname">ntadmin. </systemitem> Em seguida, será possível atribuir a todos os usuários pertencentes a esse grupo Linux o status de <literal>Domain Admin</literal> com o comando:
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 
 <sect1 xml:id="sec-samba-advanced">
  <title>Tópicos avançados</title>

  <para>
   Esta seção apresenta técnicas mais avançadas para gerenciar a parte tanto do cliente quanto do servidor da suíte do Samba.
  </para>

  <sect2 xml:id="sec-samba-advanced-compress">
   <title>Compactação de arquivos transparente no Btrfs</title>
   <para>
    O Samba permite aos clientes manipular remotamente os flags de compactação de arquivos e diretórios para compartilhamentos localizados no sistema de arquivos Btrfs. O Windows Explorer oferece um recurso para marcar arquivos/diretórios para compactação transparente em <menuchoice><guimenu>Arquivo</guimenu><guimenu>Propriedades</guimenu><guimenu>Avançado</guimenu></menuchoice> caixa de diálogo:
   </para>
   <figure>
    <title>Caixa de diálogo <guimenu>Atributos Avançados</guimenu> do Windows Explorer</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Os arquivos marcados para compactação são compactados de forma transparente e descompactados pelo sistema de arquivos base quando acessados ou modificados. Isso normalmente resulta em economia na capacidade de armazenamento em detrimento do overhead extra da CPU ao acessar o arquivo. Os arquivos e diretórios novos herdam o flag de compactação do diretório pai, exceto quando criados com a opção FILE_NO_COMPRESSION.
   </para>
   <para>
    O Windows Explorer apresenta os arquivos e diretórios compactados de forma visualmente diferente daqueles não compactados:
   </para>
   <figure>
    <title>Listagem de diretórios do Windows Explorer com arquivos compactados</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    É possível habilitar a compactação de compartilhamentos Samba manualmente adicionando
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    à configuração do compartilhamento em <filename>/etc/samba/smb.conf</filename> ou usando o YaST: <menuchoice><guimenu>Serviços de Rede</guimenu><guimenu>Servidor Samba</guimenu><guimenu>Adicionar</guimenu></menuchoice> e marcando <guimenu>Utilizar Recursos do Btrfs</guimenu>.
   </para>
   
  </sect2>

  <sect2 xml:id="sec-samba-advanced-snapshots">
   <title>Instantâneos</title>
   <para>
    Os instantâneos, também chamados de Cópias de Sombra, são cópias do estado do subvolume de um sistema de arquivos em determinado período. O Snapper é a ferramenta que gerencia os instantâneos no Linux. Os instantâneos são suportados no sistema de arquivos Btrfs ou em volumes LVM com aprovisionamento dinâmico. A suíte do Samba suporta o gerenciamento de instantâneos remotos por meio do protocolo FSRVP tanto no servidor quanto no cliente.
   </para>
   <sect3 xml:id="sec-samba-advanced-snapshots-client">
    <title>Versões anteriores</title>
    <para>
     É possível expor os instantâneos do servidor Samba a clientes do Windows remotos como versões anteriores de arquivos ou diretórios.
    </para>
    <para>
     Para habilitar instantâneos no servidor Samba, as seguintes condições devem ser atendidas:
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       O compartilhamento de rede SMB reside em um subvolume Btrfs.
      </para>
     </listitem>
     <listitem>
      <para>
       O caminho do compartilhamento de rede SMB possui um arquivo de configuração do snapper relacionado. É possível criar o arquivo do snapper com
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       Para obter mais informações sobre o snapper, consulte o <xref linkend="cha-snapper"/>.
      </para>
     </listitem>
     <listitem>
      <para>
       A árvore do diretório do instantâneo deve permitir o acesso de usuários relevantes. Para obter mais informações, consulte a seção PERMISSIONS (Permissões) da página de manual de vfs_snapper (<command>man 8 vfs_snapper</command>).
      </para>
     </listitem>
    </itemizedlist>
    <para>
     Para suportar instantâneos remotos, é necessário modificar o arquivo <filename>/etc/samba/smb.conf. </filename> Você pode fazer isso com o <menuchoice><guimenu>YaST</guimenu> <guimenu>Serviços de Rede</guimenu><guimenu>Servidor Samba</guimenu></menuchoice>, ou manualmente, incrementando a seção do compartilhamento relevante com
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     Observe que é necessário reiniciar o serviço Samba para que as mudanças manuais em <filename>smb.conf</filename> entrem em vigor:
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> systemctl restart nmb smb</screen>
    <figure xml:id="fig-yast2-samba-snapshot">
     <title>Adicionando um novo compartilhamento Samba com criação de instantâneo habilitada</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     Depois de configurados, os instantâneos criados pelo snapper para o caminho do compartilhamento Samba poderão ser acessados pelo Windows Explorer da guia <guimenu>Versões Anteriores</guimenu> de um arquivo ou diretório.
    </para>
    <figure xml:id="fig-samba-win-explorer">
     <title>A guia <guimenu>Versões Anteriores</guimenu> no Windows Explorer</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-server">
    <title>Instantâneos de compartilhamentos remotos</title>
    <para>
     Por padrão, só é possível criar e apagar instantâneos do servidor Samba localmente, pelo utilitário de linha de comando snapper ou usando o recurso de linha do tempo do snapper.
    </para>
    <para>
     É possível configurar o Samba para processar solicitações de criação e exclusão de instantâneos do compartilhamento de hosts remotos usando o FSRVP (File Server Remote VSS Protocol – Protocolo VSS Remoto do Servidor de Arquivos).
    </para>
    <para>
     Além da configuração e dos pré-requisitos documentados em <xref linkend="sec-samba-advanced-snapshots-client"/>, a seguinte configuração global é necessária no <filename>/etc/samba/smb.conf</filename>:
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     Os clientes FSRVP, incluindo o <command>rpcclient</command> do Samba e o <command>DiskShadow.exe</command> do Windows Server 2012, podem instruir o Samba a criar ou apagar um instantâneo de determinado compartilhamento e o expor como um novo compartilhamento.
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-linux">
    <title>Gerenciando instantâneos do Linux remotamente com <command>rpcclient</command></title>
    <para>
     O pacote <systemitem>samba-client</systemitem> inclui o cliente FSRVP que pode solicitar remotamente a um servidor Windows/Samba para criar e expor um instantâneo de determinado compartilhamento. Em seguida, é possível usar as ferramentas existentes no <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> para montar o compartilhamento exposto e fazer backup de seus arquivos. As solicitações ao servidor são enviadas usando o binário <command>rpcclient</command>.
    </para>
    <example>
     <title>Usando o <command>rpcclient</command> para solicitar instantâneos de compartilhamento do Windows Server 2012</title>
     <para>
      Conecte-se ao servidor <literal>win-server.example.com</literal> como administrador em um domínio <literal>EXAMPLE</literal>:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      Verifique se o compartilhamento SMB está visível para <command>rpcclient</command>:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      Verifique se o compartilhamento SMB suporta criação de instantâneo:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      Solicite a criação de um instantâneo de compartilhamento:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      Confirme se o compartilhamento de instantâneo foi exposto pelo servidor:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      Tente apagar o compartilhamento de instantâneo:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      Confirme se o compartilhamento de instantâneo foi removido pelo servidor:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-winserver">
    <title>Gerenciando instantâneos do Windows remotamente com <command>DiskShadow.exe</command></title>
    <para>
     É possível gerenciar instantâneos de compartilhamentos SMB no servidor Samba do Linux do ambiente Windows agindo também como cliente. O Windows Server 2012 inclui o utilitário <command>DiskShadow.exe</command>, que gerencia compartilhamentos remotos parecidos com o <command>rpcclient</command>, descrito em <xref linkend="sec-samba-advanced-snapshots-client-linux"/>. Observe que é necessário primeiro configurar o servidor Samba com atenção.
    </para>
    <para>
     Veja a seguir um exemplo do procedimento de configuração do servidor Samba para que o cliente do Windows Server possa gerenciar os instantâneos de seu compartilhamento. Observe que <replaceable>EXEMPLO</replaceable> é o domínio Active Directory usado no ambiente de teste, <uri>fsrvp-server.example.com</uri> é o nome de host do servidor Samba e <filename>/srv/smb</filename> é o caminho para o compartilhamento SMB.
    </para>
    <procedure>
     <title>Configuração detalhada do servidor Samba</title>
     <step>
      <para>
       Entre no domínio Active Directory pelo YaST.
      </para>
     </step>
     <step>
      <para>
       Verifique se a entrada DNS do Domínio Ativo estava correta:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step>
      <para>
       Criar subvolume Btrfs em <filename>/srv/smb</filename>
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step>
      <para>
       Criar arquivo de configuração do snapper para o caminho <filename>/srv/smb</filename>
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step>
      <para>
       Crie um novo compartilhamento com o caminho <filename>/srv/smb</filename> e a caixa de seleção <guimenu>Expor Instantâneos</guimenu> do YaST habilitada. Adicione os seguintes trechos à seção global do <filename>/etc/samba/smb.conf</filename>, como mencionado em <xref linkend="sec-samba-advanced-snapshots-server"/>:
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step>
      <para>
       Reinicie o Samba com <command>systemctl restart nmb smb</command>
      </para>
     </step>
     <step>
      <para>
       Configure permissões do snapper:
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       Verifique se todos ALLOW_USERS também têm permissão de passagem no subdiretório <filename>.snapshots</filename>.
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>Escape de caminho</title>
       <para>
        Tenha cuidado com os escapes ''\''! Inclua dois escapes para garantir que o valor armazenado em <filename>/etc/snapper/configs/&lt;config_snapper&gt;</filename> fique com apenas um escape.
       </para>
      </important>
      <para>
       "EXAMPLE\win-client$" corresponde à conta de computador cliente do Windows. O Windows emitirá as solicitações FSRVP iniciais enquanto estiver autenticado nessa conta.
      </para>
     </step>
     <step>
      <para>
       Conceda os privilégios necessários para a conta de cliente do Windows:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       O comando anterior não é necessário para o usuário "EXAMPLE\Administrator", que já recebeu os privilégios.
      </para>
     </step>
    </procedure>
    <procedure>
     <title>Configuração do cliente do Windows e <command>DiskShadow.exe</command> em ação</title>
     <step>
      <para>
       Inicialize o Windows Server 2012 (exemplo de nome de host WIN-CLIENT).
      </para>
     </step>
     <step>
      <para>
       Ingresse no mesmo domínio do Active Directory EXAMPLE que o <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>.
      </para>
     </step>
     <step>
      <para>
       Reinicialize.
      </para>
     </step>
     <step>
      <para>
       Abra o Powershell.
      </para>
     </step>
     <step>
      <para>
       Inicie o <command>DiskShadow.exe</command> e comece o procedimento de backup:
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step>
      <para>
       Especifique para a cópia de sombra persistir após a saída, redefinição ou reinicialização do programa:
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step>
      <para>
       Verifique se o compartilhamento especificado suporta instantâneos e crie um:
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name:
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step>
      <para>
       Conclua o procedimento de backup:
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step>
      <para>
       Após criar o instantâneo, tente apagá-lo e confirme a exclusão:
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-info">
  <title>Para obter mais informações</title>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>Páginas de manual:</title>
     <para>
      Para ver uma lista de todas as páginas de manual instaladas com o pacote
      <package>samba</package>, execute <command>apropos samba</command>. Abra qualquer uma das páginas de manual com <command>man <replaceable>NOME_DA_PÁGINA_DE_MANUAL</replaceable></command>.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Arquivo README específico do SUSE:</title>
     <para>
      O pacote <package>samba-client</package> contém o arquivo <filename>/usr/share/doc/packages/samba/README.SUSE</filename>.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Pacote de Documentação Adicional:</title>
     <para>
      Instale o pacote <systemitem>samba-doc</systemitem> com <command>zypper install samba-doc</command>.
     </para>
    </formalpara>
    <para>
     Esta documentação trata da instalação em <filename>/usr/share/doc/packages/samba</filename>. Ela inclui uma versão HTML das páginas de manual e uma biblioteca de configurações de exemplo (como <filename>smb.conf.SUSE</filename>).
    </para>
   </listitem>
   <listitem>
    <formalpara>
     <title>Documentação online:</title>
     <para>
      O wiki do Samba contém a <citetitle>Documentação do Usuário</citetitle> completa em <link xlink:href="https://wiki.samba.org/index.php/User_Documentation"/>.
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
