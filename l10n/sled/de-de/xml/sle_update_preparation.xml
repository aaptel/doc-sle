<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_preparation.xml" version="5.0" xml:id="cha-update-preparation">
 <title>Vorbereiten des Upgrades</title>
 <info>
  <abstract>
   <para>
    Vor Beginn des Upgrades muss das System ordnungsgemäß vorbereitet werden. Zur Vorbereitung gehören unter anderem das Sichern der Daten und das Lesen der Versionshinweise.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>Ja</dm:translation>
  </dm:docmanager>
 </info>

 <sect1 xml:id="sec-update-preparation-update">
  <title>Prüfen, ob das aktuelle System auf dem neuesten Stand ist</title>
  <para>
   Ein Upgraden des Systems wird nur von der jeweils letzten Patch-Stufe aus unterstützt. Prüfen Sie, ob die neuesten Systemaktualisierungen installiert sind. Führen Sie hierzu entweder <command>zypper patch</command> aus oder starten Sie das YaST-Modul <guimenu>Online-Update</guimenu>.
  </para>
 </sect1>

 <sect1 xml:id="sec-update-preparation-relnotes">
  <title>Lesen Sie die Versionshinweise</title>
  <para>
   In den Versionshinweisen finden Sie zusätzliche Informationen zu den Änderungen, die seit der vorangegangenen Version von <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> vorgenommen wurden. Informieren Sie sich in den Versionshinweisen über Folgendes:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     Sind bei der Hardware besondere Überlegungen zu beachten?
    </para>
   </listitem>
   <listitem>
    <para>
     Wurden erhebliche Änderungen an den verwendeten Software-Paketen vorgenommen?
    </para>
   </listitem>
   <listitem>
    <para>
     Gelten besondere Vorsichtsmaßnahmen für die vorliegende Installation?
    </para>
   </listitem>
  </itemizedlist>
  <para>
   In den Versionshinweisen finden Sie auch Informationen, die erst nach der Fertigstellung des Handbuchs bekannt wurden. Auch bekannte Probleme werden beschrieben.
  </para>
  
  <para>
   Die aktuellen Versionshinweise stehen online unter <link xlink:href="https://www.suse.com/releasenotes/"/> bereit.
  </para>
  <para>
   Alternativ finden Sie die Versionshinweise auf der Installations-DVD im Verzeichnis <filename>docu</filename>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-backup">
  <title>Anlegen einer Sicherungskopie</title>
  <para>
   Kopieren Sie die bestehenden Konfigurationsdateien vor der Aktualisierung auf ein separates Medium (wie ein Bandlaufwerk oder eine externe Festplatte), um die Daten zu sichern. Dies gilt hauptsächlich für die in <filename>/etc</filename> gespeicherten Dateien sowie für bestimmte Verzeichnisse und Dateien in <filename>/var</filename> und <filename>/opt</filename>. Zudem empfiehlt es sich, die Benutzerdaten in <filename>/home</filename> (den <envar>HOME</envar>-Verzeichnissen) auf ein Sicherungsmedium zu schreiben. Melden Sie sich zur Sicherung dieser Daten als <systemitem class="username">root</systemitem> an. Nur der Benutzer <systemitem class="username">root</systemitem> verfügt über die Leseberechtigung für alle lokalen Dateien.
  </para>
  <para>
   Wenn Sie in YaST den Installationsmodus <guimenu>Vorhandenes System aktualisieren</guimenu> ausgewählt haben, können Sie später wahlweise eine (System-)Sicherung ausführen. Sie können alle geänderten Dateien und die Dateien aus dem Verzeichnis <filename>/etc/sysconfig</filename> einschließen. Dies ist allerdings keine vollständige Sicherung, da alle anderen wichtigen, oben genannten Verzeichnisse außer Acht gelassen werden. Die Sicherungskopie befindet sich im Verzeichnis<filename>/var/adm/backup</filename>.
  </para>
 </sect1>
 <sect1 xml:id="sec-update-preparation-packagelist">
  <title>Auflisten installierter Pakete und Repositorys</title>
  <para>
   Eine Liste der installierten Pakete ist häufig von Nutzen, beispielsweise bei einer Neuinstallation einer neuen SLE-Hauptversion oder beim Zurücksetzen des Systems auf die bisherige Version.
  </para>
  <para>
   Denken Sie daran, dass nicht alle installierten Pakete oder verwendeten Repositorys in neueren Versionen von SUSE Linux Enterprise vorliegen. Einige Elemente wurden unter Umständen umbenannt, andere ersetzt. Außerdem könnten bestimmte Pakete weiterhin zu Legacy-Zwecken verfügbar sein, während standardmäßig ein anderes Paket herangezogen wird. Aus diesem Grund müssen die Dateien ggf. manuell bearbeitet werden. Dies können Sie mit einem beliebigen Texteditor durchführen.
  </para>
  <para>
   Erstellen Sie die Datei <filename>repositories.bak-repo</filename> mit einer Liste aller verwendeten Repositorys.
  </para>
  <screen><prompt role="root">root # </prompt><command>zypper</command> lr -e repositories.bak</screen>
  <para>
   Erstellen Sie außerdem die Datei <filename>installed-software.bak</filename> mit einer Liste aller installierten Pakete:
  </para>
  <screen><prompt role="root">root # </prompt><command>rpm</command> -qa --queryformat '%{NAME}\n' &gt; installed-software.bak</screen>
  <para>
   Erstellen Sie Sicherungskopien beider Dateien. Die Repositorys und die installierten Pakete können mit den folgenden Befehlen wiederhergestellt werden:
  </para>
  <screen><prompt role="root">root # </prompt><command>zypper</command> ar repositories.bak.repo
<prompt role="root">root # </prompt><command>zypper</command> install $(cat installed-software.bak)</screen>

  <note xml:id="note-update-prep-backup-package-amount">
   <title>
    Höhere Paketanzahl bei einer Aktualisierung auf eine neue Hauptversion
   </title>
   <para>
    Ein System, das auf eine neue Hauptversion upgegradet wurde (SLE <replaceable>X+1</replaceable>), enthält eventuell mehr Pakete als das ursprüngliche System (SLE <replaceable>X</replaceable>). Die Anzahl der Pakete ist außerdem höher als bei einer Neuinstallation von SLE <replaceable>X+1</replaceable> mit derselben Schemaauswahl. Hierfür sind folgende Gründe zu nennen:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Die Pakete wurden aufgeteilt, sodass Sie die gewünschte Paketauswahl noch genauer festlegen können. Zum Beispiel wurden 37 <package>texlive</package> -Pakete aus SLE 11 auf 3000 Pakete in SLE 15 aufgeteilt.
     </para>
    </listitem>
    <listitem>
     <para>
      Wenn ein Paket aufgeteilt wurde, werden bei einem Upgrade alle neuen Pakete installiert, damit in jedem Fall derselbe Funktionsumfang wie in der früheren Version zur Verfügung steht. Bei einer Neuinstallation von SLE <replaceable>X+1</replaceable> werden jedoch unter Umständen nicht mehr alle Pakete standardmäßig installiert.
     </para>
    </listitem>
    <listitem>
     <para>
      Ältere Pakete aus SLE <replaceable>X</replaceable> werden ggf. aus Kompatibilitätsgründen beibehalten.
     </para>
    </listitem>
    <listitem>
     <para>
      Die Paketabhängigkeiten und der Schemaumfang haben sich unter Umständen geändert.
     </para>
    </listitem>
   </itemizedlist>
  </note>
 </sect1>

 

 <sect1 xml:id="sec-update-preparation-vms">
  <title>Herunterfahren von VM-Gästen</title>
  <para>
   Wenn Ihr Rechner als VM-Hostserver für KVM oder Xen fungiert, müssen Sie vor der Aktualisierung alle aktiven VM-Gäste ordnungsgemäß herunterfahren. Andernfalls können Sie nach der Aktualisierung wahrscheinlich nicht mehr auf die Gäste zugreifen.
  </para>
 </sect1>

 

  <sect1 xml:id="sec-update-preparation-rmt">
   <title>Anpassen der Einrichtung Ihres SMT-Clients</title>
   <para>
    Beachten Sie Folgendes, wenn der Rechner, der upgegradet werden soll, als Client bei einem SMT-Server registriert werden soll: 
   </para>
   <para>
    Prüfen Sie, ob die Version des Skripts <command>clientSetup4SMT.sh</command> auf Ihrem Host aktuell ist. <command>clientSetup4SMT.sh</command> aus älteren Versionen von SMT kann nicht zum Verwalten von SMT 12-Clients verwendet werden. Wenn Sie auf Ihrem SMT-Server regelmäßig Software-Patches anwenden, finden Sie die neueste Version von <command>clientSetup4SMT.sh</command> immer unter <filename>&lt;SMT_HOSTNAME&gt;/repo/tools/clientSetup4SMT.sh</filename>.
   </para>

   <para>
    Falls das Upgrade Ihres Rechners auf eine höhere Version von <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> fehlschlägt, heben Sie die Registrierung des Rechners beim SMT-Server wie in <xref linkend="pro-sec-update-prep-smt-de-register" xrefstyle="select:label"/> beschrieben auf. Starten Sie danach den Upgradevorgang neu.</para>
   <procedure xml:id="pro-sec-update-prep-smt-de-register">
    <title>Aufheben einer Registrierung von SUSE Linux Enterprise Client bei einem SMT-Server</title>
     <step>
      <para>
       Melden Sie sich beim Client-Rechner an.
      </para>
     </step>
     <step>
     <para>Der folgende Schritt hängt vom aktuellen Betriebssystem des Client ab:</para>
     <itemizedlist>
      <listitem>
       <para>
        Für SUSE Linux Enterprise 11 führen Sie folgende Kommandos aus:
       </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> suse_register -E
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/suseRegister*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /var/cache/SuseRegister/lastzmdconfig.cache
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zmd/deviceid
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zmd/secret</screen>
      </listitem>
      <listitem>
       <para>
        Für SUSE Linux Enterprise 12 führen Sie folgende Kommandos aus:
       </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> SUSEConnect --de-register
<prompt>tux &gt; </prompt><command>sudo</command> SUSEConnect --cleanup
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/SUSEConnect
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/credentials.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -rf /etc/zypp/repos.d/*
<prompt>tux &gt; </prompt><command>sudo</command> rm -f /etc/zypp/services.d/*</screen>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para>
      Melden Sie sich beim SMT-Server an.
     </para>
    </step>
    <step>
     <para>
      Prüfen Sie, ob die Registrierung des Client aufgehoben wurde, indem Sie alle Client-Registrierungen aufrufen:
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> smt-list-registrations</screen>
    </step>
    <step>
     <para>
      Wird der Hostname des Client in der Ausgabe dieses Kommandos noch aufgelistet, rufen Sie die <literal>Eindeutige ID</literal> des Client in der ersten Spalte ab. (Der Client ist möglicherweise mit mehreren IDs aufgeführt.)
     </para>
    </step>
    <step>
     <para>
      Löschen Sie die Registrierung für diesen Client:
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> smt-delete-registration -g <replaceable>UNIQUE_ID</replaceable></screen>
    </step>
     <step>
     <para>
      Sollte der Client mit mehreren IDs aufgeführt sein, wiederholen Sie den obigen Schritt für jede einzelne ID.
     </para>
    </step>
    <step>
     <para>
      Prüfen Sie danach, ob die Registrierung des Client nun aufgehoben wurde, indem Sie das folgende Kommando erneut ausführen:
     </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> smt-list-registrations</screen>
    </step>
   </procedure>
  </sect1>

 <sect1 xml:id="sec-update-preparation-disk">
  <title>Festplattenspeicher</title>

  <para>
   Software weist normalerweise von Version zu Version mehr Umfang auf. Folglich sollten Sie vor dem Aktualisieren den verfügbaren Partitionsspeicher überprüfen. Wenn Sie befürchten, dass der Speicherplatz nicht ausreicht, sichern Sie Ihre Daten und erhöhen Sie dann den verfügbaren Speicherplatz, indem Sie beispielsweise die Größe von Partitionen ändern. Es gibt keine Faustregel hinsichtlich des Speicherplatzes einzelner Partitionen. Die Platzanforderungen hängen von Ihrem bestimmten Partitionsprofil und von der ausgewählten Software ab.
  </para>

  <note>
   <title>Automatische Prüfung des verfügbaren Speicherplatzes in YaST</title>
   <para>
    YaST prüft während des Aktualisierungsvorgangs den freien verfügbaren Speicherplatz und zeigt dem Benutzer eine Warnmeldung an, wenn die verfügbare Menge möglicherweise nicht für die Installation ausreicht. Wenn Sie die Aktualisierung in diesem Fall dennoch durchführen, kann das <emphasis>System unbrauchbar</emphasis> werden! Sie sollten die Warnmeldung nur dann ignorieren und mit der Aktualisierung fortfahren, wenn Sie genau wissen, was Sie tun (da Sie dies in einem Vorabtest abgeklärt haben).
   </para>
  </note>

  <sect2 xml:id="sec-update-preparation-disk-space">
   <title>Ermitteln des freien Speicherplatzes auf Nicht-Btrfs-Dateisystemen</title>
   <para>
    Listen Sie mit dem Kommando <command>df</command> den verfügbaren Speicherplatz auf. In <xref linkend="ex-update-df"/> ist beispielsweise <filename>/dev/sda3</filename> die root-Partition (eingehängt als <filename>/</filename>).
   </para>
   <example xml:id="ex-update-df">
    <title>Über <command>df ‑h</command> angezeigte Liste</title>
<screen os="sled">Filesystem     Size  Used Avail Use% Mounted on
/dev/sda3       74G   22G   53G  29% /
tmpfs          506M     0  506M   0% /dev/shm
/dev/sda5      116G  5.8G  111G   5% /home
/dev/sda1       39G  1.6G   37G   4% /windows/C
/dev/sda2      4.6G  2.6G  2.1G  57% /windows/D</screen>

   </example>
  </sect2>

  <sect2 xml:id="sec-update-preparation-disk-btrfs-on-root">
   <title>Ermitteln des freien Speicherplatzes auf Btrfs-root-Dateisystemen</title>
   
   <para>
     In einem Btrfs-Dateisystem kann die Ausgabe von <command>df</command> irreführend sein, weil ein Btrfs-Dateisystem zusätzlich zum Speicherplatz, den die Rohdaten zuordnen, auch Speicherplatz für Metadaten zuordnet und verwendet.
    </para>
    <para>
     Folglich meldet ein Btrfs-Dateisystem womöglich, dass es keinen Speicherplatz mehr hat, obwohl anscheinend noch genügend vorhanden ist. In diesem Fall ist der gesamte Speicherplatz, der den Metadaten zugeordnet ist, belegt. Weitere Informationen finden Sie unter <command>man 8 btrfs-filesystem</command> und <link xlink:href="https://btrfs.wiki.kernel.org/index.php/FAQ"/>.
   </para>
   <para>
    Wenn Sie Btrfs als root-Dateisysteme auf dem Computer nutzen, muss ausreichend freier Speicherplatz zur Verfügung stehen. Prüfen Sie den verfügbaren Speicherplatz auf allen eingehängten Partitionen. Im schlimmsten Fall belegt ein Upgrade ebenso viel Speicherplatz wie das aktuelle root-Dateisystem (ohne <filename>/.snapshot</filename>) für einen neuen Snapshot.
   </para>
   <para>
    Die folgenden Empfehlungen haben sich bewährt:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Bei allen Dateisystemen (auch Btrfs) benötigen Sie ausreichend freien Speicherplatz, damit Sie große RPMs herunterladen und installieren können. Der Speicherplatz der alten RPMs wird erst dann freigegeben, wenn die neuen RPMs installiert sind.
     </para>
    </listitem>
    <listitem>
     <para>
      Bei Btrfs mit Snapshots benötigen Sie mindestens so viel freien Speicherplatz, wie von der aktuellen Installation belegt wird. Es wird mindestens der doppelte freie Speicherplatz empfohlen, wie von der aktuellen Installation belegt wird.
     </para>
     <para>
      Falls nicht ausreichend freier Speicherplatz verfügbar ist, können Sie ältere Snapshots mit <command>snapper</command> löschen:
     </para>
<screen><prompt role="root">root # </prompt><command>snapper</command> list
<prompt role="root">root # </prompt><command>snapper</command> delete NUMBER</screen>
     <para>
      Dies reicht jedoch nicht in allen Fällen aus. Vor der Migration belegen die meisten Snapshots nur wenig Platz.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-update-preparation-multiversion">
  <title>Vorübergehende Deaktivierung der Unterstützung mehrerer Kernel-Versionen</title>
  <para>
   <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> ermöglicht die Installation mehrerer Kernel-Versionen. Hierfür müssen die entsprechenden Einstellungen in <filename>/etc/zypp/zypp.conf</filename> aktiviert werden. Für das Upgrade auf ein Service Pack muss diese Funktion vorübergehend deaktiviert werden. Sobald die Aktualisierung erfolgreich abgeschlossen wurde, kann die Unterstützung mehrerer Versionen wieder aktiviert werden. Zur Deaktivierung der Unterstützung mehrerer Versionen müssen die entsprechenden Zeilen in der Datei <filename>/etc/zypp/zypp.conf</filename> auf Kommentar gesetzt werden. Das Ergebnis sollte wie folgt aussehen:
  </para>
<screen>#multiversion = provides:multiversion(kernel)
#multiversion.kernels = latest,running</screen>
  <para>
   Wenn Sie diese Funktion nach einer erfolgreichen Aktualisierung wieder aktivieren möchten, entfernen Sie die Kommentarzeichen. Weitere Informationen zur Unterstützung mehrerer Versionen finden Sie in <xref linkend="sec-tuning-multikernel-enable"/>.
  </para>
 </sect1>
 
 
</chapter>
