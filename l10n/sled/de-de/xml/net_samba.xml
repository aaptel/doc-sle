<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_samba.xml" version="5.0" xml:id="cha-samba">
 <title>Samba</title>
 <info>
  <abstract>
   <para>
    Mit Samba kann ein Unix-Computer als Datei- und Druckserver für macOS-, Windows- und OS/2-Computer konfiguriert werden. Samba ist mittlerweile ein sehr umfassendes und komplexes Produkt. Konfigurieren Sie Samba mit YaST oder indem Sie die Konfigurationsdatei manuell bearbeiten.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>Ja</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-samba-term">
  <title>Terminologie</title>

  <para>
   Im Folgenden werden einige Begriffe erläutert, die in der Samba-Dokumentation und im YaST-Modul verwendet werden.
  </para>

  <variablelist>
   <varlistentry>
    <term>SMB-Protokoll</term>
    <listitem>
     <para>
      Samba verwendet das SMB-Protokoll (Server Message Block), das auf den <phrase role="productname">NetBIOS</phrase>-Diensten basiert. Microsoft veröffentlichte das Protokoll, damit auch andere Softwarehersteller Anbindungen an ein Microsoft-Domänennetzwerk einrichten konnten. Samba setzt das SMB- auf das TCP/IP-Protokoll auf. Entsprechend muss auf allen Clients das TCP/IP-Protokoll installiert sein.
     </para>
     
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFS-Protokoll</term>
    <listitem>
     <para>
      Das CIFS-Protokoll (Common Internet File System) ist ein weiteres von Samba unterstütztes Protokoll. CIFS definiert ein Standardprotokoll für den Fernzugriff auf Dateisysteme über das Netzwerk, das Benutzergruppen die netzwerkweite Zusammenarbeit und gemeinsame Dokumentbenutzung ermöglicht.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS</term>
    <listitem>
     <para>
        NetBIOS ist eine Softwareschnittstelle (API) für die Kommunikation zwischen Computern, die einen Name Service bereitstellen. Mit diesem Dienst können die an das Netzwerk angeschlossenen Computer Namen für sich reservieren. Nach dieser Reservierung können die Computer anhand ihrer Namen adressiert werden. Für die Überprüfung der Namen gibt es keine zentrale Instanz. Jeder Computer im Netzwerk kann beliebig viele Namen reservieren, solange die Namen noch nicht Gebrauch sind. Die NetBIOS-Schnittstelle kann in unterschiedlichen Netzwerkarchitekturen implementiert werden. Eine Implementierung, die relativ eng mit der Netzwerkhardware arbeitet, ist <phrase role="productname">NetBEUI</phrase> (häufig auch als <phrase role="productname">NetBIOS</phrase> bezeichnet). Mit NetBIOS implementierte Netzwerkprotokolle sind IPX (NetBIOS über TCP/IP) von Novell und TCP/IP.
     </para>
     <para>
      Die per TCP/IP übermittelten NetBIOS-Namen haben nichts mit den in der Datei <filename>/etc/hosts</filename> oder per DNS vergebenen Namen zu tun. NetBIOS ist ein eigener, vollständig unabhängiger Namensraum. Es empfiehlt sich jedoch, für eine einfachere Administration NetBIOS-Namen zu vergeben, die den jeweiligen DNS-Hostnamen entsprechen, oder DNS nativ zu verwenden. Für einen Samba-Server ist dies die Voreinstellung.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba-Server</term>
    <listitem>
     <para>
      Samba-Server stellt SMB/CIFS-Dienste sowie NetBIOS over IP-Namensdienste für Clients zur Verfügung. Für Linux gibt es drei Dämonen für Samba-Server: smbd für SMB/CIFS-Dienste, nmbd für Naming Services und winbind für Authentifizierung.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba-Client</term>
    <listitem>
     <para>
      Der Samba-Client ist ein System, das Samba-Dienste von einem Samba-Server über das SMB-Protokoll nutzt. Das Samba-Protokoll wird von gängigen Betriebssystemen wie Windows und MacOS unterstützt. Auf den Computern muss das TCP/IP-Protokoll installiert sein. Für die verschiedenen UNIX-Versionen stellt Samba einen Client zur Verfügung. Für Linux gibt es zudem ein Dateisystem-Kernel-Modul für SMB, das die Integration von SMB-Ressourcen auf Linux-Systemebene ermöglicht. Sie brauchen für den Samba-Client keinen Dämon auszuführen.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Freigaben</term>
    <listitem>
     <para>
       Freigaben SMB-Server stellen den Clients Ressourcen in Form von Freigaben () zur Verfügung. Freigaben sind Drucker und Verzeichnisse mit ihren Unterverzeichnissen auf dem Server. Eine Freigabe wird unter einem eigenen Namen exportiert und kann von Clients unter diesem Namen angesprochen werden. Der Freigabename kann frei vergeben werden. Er muss nicht dem Namen des exportierten Verzeichnisses entsprechen. Ebenso wird einem Drucker ein Name zugeordnet. Clients können über den Namen auf den Drucker zugreifen.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
        Ein Domänencontroller (DC) ist ein Server, der Konten in der Domäne verwaltet. Zur Datenreplikation stehen zusätzliche Domain Controller in einer Domäne zur Verfügung.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-samba-server-sled" os="sled">
  <title>Installieren eines Samba-Servers</title>
  <para>
   Installieren eines Samba-Servers wird von SUSE Linux Enterprise Desktop nicht unterstützt. Informationen zur Installation und Konfiguration eines Samba-Servers finden Sie im <citetitle>Administrationshandbuch</citetitle> für SUSE Linux Enterprise Server.
  </para>
 </sect1>
 
 
 
 <sect1 xml:id="sec-samba-client-inst">
  <title>Konfigurieren der Clients</title>

  <para>
   Clients können auf den Samba-Server nur über TCP/IP zugreifen. NetBEUI oder NetBIOS über IPX können mit Samba nicht verwendet werden.
  </para>

  <sect2 xml:id="sec-samba-client-inst-yast">
   <title>Konfigurieren eines Samba-Clients mit YaST</title>
   <para>
    Konfigurieren Sie einen Samba-Client, um auf Ressourcen (Dateien oder Drucker) auf dem Samba- oder Windows-Server zuzugreifen. Geben Sie im Dialogfeld <menuchoice>  <guimenu>Netzwerkdienste</guimenu>
     <guimenu>Windows-Domänenmitgliedschaft</guimenu></menuchoice> die NT- oder Active Directory-Domäne oder -Arbeitsgruppe an. Wenn Sie <guimenu>Zusätzlich SMB-Informationen für Linux-Authentifizierung verwenden </guimenu> aktivieren, erfolgt die Benutzerauthentifizierung über den Samba, NT- oder Kerberos-Server.
   </para>
   <para>
    Klicken Sie für erweiterte Konfigurationsoptionen auf <guimenu>Einstellungen für Experten</guimenu>. Sie können z. B. über die Tabelle <guimenu>Serververzeichnisse einhängen</guimenu> das automatische Einhängen des Server-Basisverzeichnisses bei der Authentifizierung aktivieren. Auf diese Weise können Benutzer auf Ihre Home-Verzeichnisse zugreifen, wenn sie auf CIFS gehostet werden. Einzelheiten finden Sie auf der man-Seite zu <systemitem>pam_mount</systemitem>.
   </para>
   <para>
    Bestätigen Sie zum Abschluss alle Einstellungen, um die Konfiguration zu beenden.
   </para>
  </sect2>
  <sect2 xml:id="sec-samba-client-old-server">
   <title>Einhängen von SMB1-Freigaben auf Clients</title>
   <para>
    Die erste Version des SMB-Netzwerkprotokolls, SMB1, ist ein altes und unsicheres Protokoll, das von seinem Initiator Microsoft nicht mehr verwendet wird. Aus Sicherheitsgründen werden mit dem Kommando <command>mount</command> unter <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> nur SMB-Freigaben eingehängt, die standardmäßig neuere Protokollversionen verwenden, nämlich SMB 2.1, SMB 3.0 oder SMB 3.02.
   </para>
   <para>
    Dies betrifft jedoch nur das Kommando <command>mount</command> und das Einhängen über <filename>/etc/fstab</filename>. SMB1 ist standardmäßig noch verfügbar, wenn Sie Folgendes verwenden:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Das Tool <command>smbclient</command>.
     </para>
    </listitem>
    <listitem>
     <para>
      Die Samba-Serversoftware, die im Lieferumfang von <phrase os="sles;sled">SUSE Linux Enterprise Server</phrase> enthalten ist.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    In manchen Einrichtungen führt diese Standardeinstellung zu Verbindungsfehlern, weil nur SMB1 verwendet werden kann:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Einrichtungen, die einen SMB-Server verwenden, der keine neueren SMB-Protokollversionen unterstützt. Windows bietet SMB 2.1-Unterstützung seit Windows 7 und Windows Server 2008 an.
     </para>
    </listitem>
    <listitem>
     <para>
      Einrichtungen, die auf Unix-Erweiterungen von SMB1/CIFS angewiesen sind. Diese Erweiterungen wurden nicht auf neuere Protokollversionen portiert.
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>Geringere Systemsicherheit</title>
    <para>
     Wenn Sie die folgenden Anweisungen befolgen, können Sie Sicherheitsprobleme für sich nutzen. Weitere Informationen zu diesen Problemen finden Sie unter <link xlink:href="https://blogs.technet.microsoft.com/filecab/2016/09/16/stop-using-smb1/"/>.
    </para>
    <para>
     Upgraden Sie Ihren Server so bald wie möglich, um eine SMB-Version mit höherer Sicherheit zu verwenden.
    </para>
    
   </important>
   <para>
    Wenn Sie SMB1-Freigaben auf dem aktuellen <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>-Kernel aktivieren müssen, fügen Sie die Option <option>vers=1.0</option> zur verwendeten <command>mount</command>-Kommandozeile hinzu:
   </para>
   <screen><prompt role="root">root # </prompt>mount –t smbfs <replaceable>IP_ADDRESS</replaceable>:/<replaceable>SHARE</replaceable> /<replaceable>MOUNT_POINT</replaceable> –o username=<replaceable>USER_ID</replaceable>,workgroup=<replaceable>WORKGROUP_NAME</replaceable>,<emphasis role="bold">vers=1.0</emphasis></screen>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-anmeld-serv">
  <title>Samba als Anmeldeserver</title>

  <para>
   In Unternehmenseinstellungen ist es oft wünschenswert, nur denjenigen Benutzern Zugriff zu gewähren, die bei einer zentralen Instanz registriert sind. In einem Windows-basierten Netzwerk wird diese Aufgabe von einem Primary Domain Controller (PDC) übernommen. Sie können einen Windows NT-Server verwenden, der als PDC konfiguriert ist; diese Aufgabe kann aber auch mithilfe eines Samba-Servers ausgeführt werden. Es müssen Einträge im Abschnitt <literal>[global]</literal> von <filename>smb.conf</filename> vorgenommen werden. Diese werden in <xref linkend="dat-samba-smb-conf-dom"/> beschrieben.
  </para>

  <example xml:id="dat-samba-smb-conf-dom">
   <title>Abschnitt „global“ in smb.conf</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   Die Benutzerkonten und Passwörter müssen in ein Windows-konformes Verschlüsselungsformat umgewandelt werden. Verwenden Sie hierfür den Befehl <command>smbpasswd</command> <option> -a name</option>. Da nach dem Windows-Domänenkonzept auch die Computer selbst ein Domänenkonto benötigen, wird dieses mit den folgenden Kommandos angelegt:
  </para>

<screen>useradd hostname
smbpasswd -a -m hostname</screen>

  <para>
   Mit dem Befehl <command>useradd</command> wird ein Dollarzeichen hinzugefügt. Der Befehl <command>smbpasswd</command> fügt dieses bei der Verwendung des Parameters <option>-m</option> automatisch hinzu. In der kommentierten Beispielkonfiguration (<filename>/usr/share/doc/packages/Samba/examples/smb.conf.SuSE</filename>) sind Einstellungen enthalten, die diese Aufgabe automatisieren.
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m
     </screen>

  <para>
   Um sicherzustellen, dass Samba dieses Skript korrekt ausführen kann, wählen Sie einen Samba-Benutzer mit den erforderlichen Administratorberechtigungen und fügen Sie ihn zur Gruppe <systemitem class="groupname">ntadmin</systemitem> hinzu. Anschließend können Sie allen Mitgliedern der Linux-Gruppe den Status <literal>Domain Admin</literal> zuweisen, indem Sie folgendes Kommando eingeben:
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 
 <sect1 xml:id="sec-samba-advanced">
  <title>Weitere Themen</title>

  <para>
   In diesem Abschnitt lernen Sie fortgeschrittene Vefahren zur Verwaltung des Client- und des Serverteils der Samba-Suite kennen.
  </para>

  <sect2 xml:id="sec-samba-advanced-compress">
   <title>Transparente Dateikomprimierung mit Btrfs</title>
   <para>
    Mit Samba können die Clients die Flags für die Datei- und Verzeichniskomprimierung für Freigaben, die sich im Btrfs-Dateisystem befinden, im Fernverfahren bearbeiten. Windows Explorer bietet im Dialogfeld <menuchoice><guimenu>Datei</guimenu><guimenu>Eigenschaften</guimenu><guimenu>Erweitert</guimenu></menuchoice> die Möglichkeit, die Dateien/Verzeichnisse zur transparenten Komprimierung zu kennzeichnen:
   </para>
   <figure>
    <title>Dialogfeld <guimenu>Erweiterte Attribute</guimenu> in Windows Explorer</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Die zur Komprimierung gekennzeichneten Dateien werden beim Zugreifen oder Ändern transparent durch das zugrunde liegende Dateisystem komprimiert bzw. dekomprimiert. Damit sparen Sie Speicherplatz, doch beim Zugreifen auf die Datei wird die CPU stärker beansprucht. Neue Dateien und Verzeichnisse übernehmen das Komprimierungs-Flag vom übergeordneten Verzeichnis, sofern sie nicht mit der Option FILE_NO_COMPRESSION erstellt werden.
   </para>
   <para>
    Komprimierte Dateien und Verzeichnisse werden in Windows Explorer anders dargestellt als nicht komprimierte Dateien und Verzeichnisse:
   </para>
   <figure>
    <title>Windows Explorer-Anzeige mit komprimierten Dateien</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Sie können die Komprimierung der Samba-Freigabe wahlweise manuell aktivieren (fügen Sie hierzu
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    in die Freigabekonfiguration in <filename>/etc/samba/smb.conf</filename> ein) oder mit YaST. Wählen Sie hierzu <menuchoice><guimenu>Netzwerkdienste</guimenu><guimenu>Samba-Server</guimenu><guimenu>Hinzufügen</guimenu></menuchoice>, und aktivieren Sie die Option <guimenu>Btrfs-Funktionen verwenden</guimenu>.
   </para>
   
  </sect2>

  <sect2 xml:id="sec-samba-advanced-snapshots">
   <title>Aufnahmen</title>
   <para>
    Snapshots (auch als Schattenkopien bezeichnet) sind Kopien des Zustands eines Subvolumens in einem Dateisystem zu einem bestimmten Zeitpunkt. Die Verwaltung dieser Snapshots in Linux erfolgt mit Snapper. Die Snapshots werden auf dem Btrfs-Dateisystem sowie auf LVM-Volumes mit Thin Provisioning unterstützt. Die Samba-Suite unterstützt die Verwaltung von Remote-Snapshots über das FSRVP-Protokoll sowohl auf Server- als auch auf Clientseite.
   </para>
   <sect3 xml:id="sec-samba-advanced-snapshots-client">
    <title>Frühere Versionen</title>
    <para>
     Die Snapshots auf einem Samba-Server können für entfernte Windows-Clients als Datei- oder Verzeichnis-Vorgängerversionen gezeigt werden.
    </para>
    <para>
     Zum Aktivieren von Snapshots auf einem Samba-Server müssen die folgenden Voraussetzungen erfüllt sein:
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       Die SMB-Netzwerkfreigabe befindet sich auf einem Btrfs-Subvolume.
      </para>
     </listitem>
     <listitem>
      <para>
       Für den Pfad der SMB-Netzwerkfreigabe ist eine zugehörige Snapper-Konfigurationsdatei vorhanden. Sie können die Snapper-Datei wie folgt erstellen:
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       Weitere Informationen zu Snapper finden Sie in <xref linkend="cha-snapper"/>.
      </para>
     </listitem>
     <listitem>
      <para>
       Der Snapshot-Verzeichnisbaum muss den Zugriff für relevante Benutzer ermöglichen. Weitere Informationen finden Sie auf der man-Seite zu vfs_snapper (<command>man 8 vfs_snapper</command>) im Abschnitt zu den Berechtigungen.
      </para>
     </listitem>
    </itemizedlist>
    <para>
     Sollen Remote-Snapshots unterstützt werden, 
müssen Sie die Datei <filename>/etc/samba/smb.conf</filename> bearbeiten. Verwenden Sie hierzu wahlweise <menuchoice><guimenu>YaST</guimenu><guimenu>Netzwerkdienste</guimenu><guimenu>Samba-Server</guimenu></menuchoice>, oder bearbeiten Sie den relevanten Freigabeabschnitt manuell mit
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     Damit die manuellen Änderungen an <filename>smb.conf</filename> in Kraft treten, müssen Sie den Samba-Service wie folgt neu starten:
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> systemctl restart nmb smb</screen>
    <figure xml:id="fig-yast2-samba-snapshot">
     <title>Hinzufügen einer neuen Samba-Freigabe mit aktivierter Snapshot-Aufnahme</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     Nach der Konfiguration können Sie auf die Snapshots, die Snapper für den Samba-Freigabepfad erstellt hat, in Windows Explorer über die Registerkarte <guimenu>Vorgängerversionen</guimenu> für eine Datei oder ein Verzeichnis zugreifen.
    </para>
    <figure xml:id="fig-samba-win-explorer">
     <title>Die Registerkarte <guimenu>Vorgängerversionen</guimenu> in Windows Explorer</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-server">
    <title>Remote-Snapshots für Freigaben</title>
    <para>
     Standardmäßig können Snapshots lediglich lokal auf dem Samba-Server erstellt und gelöscht werden (mit dem Kommandozeilenprogramm Snapper oder mit der Zeitleistenfunktion in Snapper).
    </para>
    <para>
     Sie können Samba so konfigurieren, dass Anfragen zum Erstellen und Löschen von Snapshots für Freigaben verarbeitet werden, die von entfernten Hosts über das FSRVP (File Server Remote VSS-Protokoll) gesendet werden.
    </para>
    <para>
     Neben den Konfigurationsschritten und Voraussetzungen in <xref linkend="sec-samba-advanced-snapshots-client"/> ist die folgende globale Konfiguration in <filename>/etc/samba/smb.conf</filename> erforderlich:
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     FSRVP-Clients (auch <command>rpcclient</command> in Samba und <command>DiskShadow.exe</command> in Windows Server 2012) können dann Samba anweisen, einen Snapshot für eine bestimmte Freigabe zu erstellen und den Snapshot als neue Freigabe zu zeigen.
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-linux">
    <title>Fernverwaltung von Snapshots in Linux mit <command>rpcclient</command></title>
    <para>
     Das Paket <systemitem>samba-client</systemitem> umfasst einen FSRVP-Client, der im Fernverfahren eine Anfrage an einen Windows-/Samba-Server stellen kann, einen Snapshot für eine bestimmte Freigabe zu erstellen und zu zeigen. Anschließend können Sie die gezeigte Freigabe mit den vorhandenen Werkzeugen in <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> einhängen und die Dateien in dieser Freigabe sichern. Die Anfragen werden über die Binärdatei <command>rpcclient</command> an den Server gesendet.
    </para>
    <example>
     <title>Anfordern eines Snapshots für eine Windows Server 2012-Freigabe mit <command>rpcclient</command></title>
     <para>
      Stellen Sie eine Verbindung zum Server <literal>win-server.example.com</literal> als Administrator in der Domäne <literal>EXAMPLE</literal> her:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      Überprüfen Sie, ob die SMB-Freigabe für <command>rpcclient</command> sichtbar ist:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      Überprüfen Sie, ob die SMB-Freigabe das Erstellen von Snapshots unterstützt:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      Fordern Sie die Erstellung eines Snapshots für eine Freigabe an:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      Überprüfen Sie, ob der Snapshot der Freigabe durch den Server gezeigt wird:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      Versuchen Sie, den Snapshot der Freigabe zu löschen:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      Überprüfen Sie, ob der Snapshot der Freigabe durch den Server entfernt wurde:
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-winserver">
    <title>Fernverwaltung von Snapshots in Windows mit <command>DiskShadow.exe</command></title>
    <para>
     Sie können Snapshots von SMB-Freigaben auf dem Linux Samba-Server auch über die Windows-Umgebung, die als Client auftritt, verwalten. Mit dem Dienstprogramm <command>DiskShadow.exe</command> in Windows Server 2012 verwalten Sie Remote-Freigaben ähnlich wie mit <command>rpcclient</command> (siehe <xref linkend="sec-samba-advanced-snapshots-client-linux"/>). Zunächst muss jedoch der Samba-Server ordnungsgemäß eingerichtet werden.
    </para>
    <para>
     Im Folgenden wird erläutert, wie Sie einen Samba-Server so konfigurieren, dass der Windows Server-Client die Snapshots der Freigaben auf dem Samba-Server verwalten kann. <replaceable>EXAMPLE</replaceable> ist der Name der Active Directory-Domäne in der Testumgebung,
     <uri>fsrvp-server.example.com</uri> ist der Hostname des Samba-Servers und <filename>/srv/smb</filename> ist der Pfad zur SMB-Freigabe.
    </para>
    <procedure>
     <title>Ausführliche Konfiguration des Samba-Servers</title>
     <step>
      <para>
       Treten Sie der Active Directory-Domäne mithilfe von YaST bei.
      </para>
     </step>
     <step>
      <para>
       Prüfen Sie, ob der DNS-Eintrag der Active Directory-Domäne korrekt ist:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step>
      <para>
       Erstellen Sie ein Btrfs-Subvolume unter <filename>/srv/smb</filename>:
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step>
      <para>
       Erstellen Sie eine Snapper-Konfigurationsdatei für den Pfad <filename>/srv/smb</filename>:
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step>
      <para>
       Erstellen Sie eine neue Freigabe mit dem Pfad <filename>/srv/smb</filename> und aktivieren Sie in YaST das Kontrollkästchen <guimenu>Snapshots zeigen</guimenu>. Fügen Sie in jedem Fall die folgenden Snippets in den globalen Abschnitt der Datei <filename>/etc/samba/smb.conf</filename> ein (siehe <xref linkend="sec-samba-advanced-snapshots-server"/>):
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step>
      <para>
       Starten Sie Samba mit <command>systemctl restart nmb smb</command> neu.
      </para>
     </step>
     <step>
      <para>
       Konfigurieren Sie die Snapper-Berechtigungen:
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       Überprüfen Sie, ob alle unter ALLOW_USERS aufgeführten Benutzer auch die Berechtigung für das Traversal des Unterverzeichnisses <filename>.snapshots</filename> besitzen.
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>Escape-Zeichen bei Pfaden</title>
       <para>
        Gehen Sie mit dem Escape-Zeichen „\“ vorsichtig vor! Setzen Sie das Escape-Zeichen zweimal, damit der Wert in <filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename> ordnungsgemäß auskommentiert wird.
       </para>
      </important>
      <para>
       „EXAMPLE\win-client$“ bezeichnet das Windows-Clientkonto. Die anfänglichen FSRVP-Anfragen von Windows werden mit diesem Konto ausgegeben.
      </para>
     </step>
     <step>
      <para>
       Erteilen Sie dem Windows-Clientkonto die erforderlichen Berechtigungen:
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       Für den Benutzer „EXAMPLE\Administrator“ muss das obige Kommando nicht ausgeführt werden, da diese Konto bereits die Berechtigungen besitzt.
      </para>
     </step>
    </procedure>
    <procedure>
     <title>Einrichten des Windows-Clients und Ausführen von <command>DiskShadow.exe</command></title>
     <step>
      <para>
       Booten Sie Windows Server 2012 (Beispiel-Hostname: WIN-CLIENT).
      </para>
     </step>
     <step>
      <para>
       Treten Sie derselben Active Directory-Domäne EXAMPLE bei wie mit dem <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>.
      </para>
     </step>
     <step>
      <para>
       Booten Sie den Computer neu.
      </para>
     </step>
     <step>
      <para>
       Öffnen Sie die Powershell.
      </para>
     </step>
     <step>
      <para>
       Starten Sie <command>DiskShadow.exe</command>, und beginnen Sie den Sicherungsvorgang:
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step>
      <para>
       Geben Sie an, dass die Schattenkopie auch beim Beenden des Programms, beim Zurücksetzen und beim Neubooten erhalten bleiben soll:
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step>
      <para>
       Überprüfen Sie, ob die angegebene Freigabe Snapshots unterstützt, und erstellen Sie einen Snapshot:
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name:
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step>
      <para>
       Beenden Sie den Sicherungsvorgang:
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step>
      <para>
       Versuchen Sie, den erstellten Snapshot zu löschen, und überprüfen Sie, ob er tatsächlich gelöscht wurde:
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-info">
  <title>Weiterführende Informationen</title>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>man-Seiten:</title>
     <para>
      Eine Liste aller man-Seiten, die mit dem Paket
      <package>samba</package>installiert sind, erhalten Sie durch Ausführen von <command>apropos samba</command>. Öffnen Sie eine der man-Seiten mit <command>man <replaceable>NAME_OF_MAN_PAGE</replaceable></command>.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>SUSE-spezifische README-Datei:</title>
     <para>
      Das Paket <package>samba-client</package> enthält die Datei <filename>/usr/share/doc/packages/samba/README.SUSE</filename>.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Weitere Dokumentation im Paket:</title>
     <para>
      Installieren Sie das Paket <systemitem>samba-doc</systemitem> mit <command>zypper install samba-doc</command>.
     </para>
    </formalpara>
    <para>
     Diese Dokumentation wird im Pfad <filename>/usr/share/doc/packages/samba</filename> installiert. Sie enthält eine HTML-Version der man-Seiten sowie eine Bibliothek der Konfigurationsbeispiele (wie <filename>smb.conf.SUSE</filename>).
    </para>
   </listitem>
   <listitem>
    <formalpara>
     <title>Online-Dokumentation:</title>
     <para>
      Das Samba-Wiki enthält eine umfangreiche <citetitle>Benutzerdokumentation</citetitle> unter <link xlink:href="https://wiki.samba.org/index.php/User_Documentation"/>.
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
