<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_samba.xml" version="5.0" xml:id="cha-samba">
 <title>Samba</title>
 <info>
  <abstract>
   <para>
    使用 Samba，就可以將 Unix 機器設定為 macOS、Windows 以及 OS/2 機器的檔案與列印伺服器。Samba 已經是一個開發至完全成熟且相當複雜的產品。使用 YaST 或手動編輯組態檔案來設定 Samba。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-samba-term">
  <title>術語</title>

  <para>
   下列為 Samba 文件和 YaST 模組中常用的詞彙。
  </para>

  <variablelist>
   <varlistentry>
    <term>SMB 通訊協定</term>
    <listitem>
     <para>
      Samba 使用以 <phrase role="productname">NetBIOS</phrase> 服務為基礎的 SMB (伺服器訊息區塊) 通訊協定。由於 Microsoft 發行了此通訊協定，因此其他的軟體製造商可以建立連接至 Microsoft 網域網路的連接。使用 Samba，SMB 通訊協定就可以在 TCP/IP 通訊協定上運作，因此 TCP/IP 通訊協定必須安裝在所有的用戶端上。
     </para>
     
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFS 通訊協定</term>
    <listitem>
     <para>
      CIFS (常用網際網路檔案系統) 通訊協定是 Samba 支援的另一種通訊協定。CIFS 定義用於網路上的標準遠端檔案系統存取通訊協定，讓使用者群組可以透過網路分工合作和共享文件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS</term>
    <listitem>
     <para>
       NetBIOS 是用來在提供名稱服務的機器之間進行通訊的軟體介面 (API)。它允許連接至網路的機器保留自己的名稱。在保留後，就可以使用名稱來定址這些機器。在此沒有檢查名稱的中央程序。在網路上的任何機器都可以保留它所需的任何數量名稱，只要這些名稱尚未使用。可以針對不同的網路結構實作 NetBIOS 介面。<phrase role="productname">NetBEUI</phrase> 是與網路硬體結合相對密切的一種實作，不過通常稱為 <phrase role="productname">NetBIOS</phrase>。與 NetBIOS 一起執行的網路通訊協定是 Novell 的 IPX (經由 TCP/IP 的 NetBIOS) 與 TCP/IP。
     </para>
     <para>
      經由 TCP/IP 所傳送的 NetBIOS 名稱，與 <filename>/etc/hosts</filename> 中所使用的名稱，或由 DNS 所定義的名稱完全不相同。NetBIOS 使用自己完全獨立的命名慣例。不過，為了方便管理，一般建議使用與 DNS 主機名稱相對應的名稱，或者在本地使用 DNS。Samba 預設是使用此對應名稱。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba 伺服器</term>
    <listitem>
     <para>
      Samba 伺服器可為用戶端提供 SMB/CIFS 服務和 NetBIOS over IP 命名服務。對於 Linux 系統，Samba 伺服器有三種精靈可用：smbd (用於 SMB/CIFS 服務)、nmbd (用於命名服務) 及 winbind (用於驗証)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba 用戶端</term>
    <listitem>
     <para>
      Samba 用戶端是透過 SMB 通訊協定，使用 Samba 伺服器所提供之 Samba 服務的系統。常用作業系統 (例如 Windows 和 macOS) 都支援 SMB 通訊協定。TCP/IP 通訊協定必須安裝在所有的電腦上。Samba 提供適用於不同 Unix 類別的用戶端。就 Linux 而言，有一個 SMB 的核心模組，允許在 Linux 系統層級上整合 SMB 資源。您不必為 Samba 用戶端執行任何精靈。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>共享</term>
    <listitem>
     <para>
      SMB 伺服器透過共用為其用戶端提供資源。共享是指印表機和位在伺服器上的目錄及其子目錄。它是利用名稱來輸出，並且可藉由其名稱來存取。共用名稱可以設成任何名稱，它並不需要是輸出目錄的名稱。也會指定一個名稱給印表機。用戶端可透過印表機的名稱存取印表機。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
       網域控制器 (DC) 是處理網域中帳戶的伺服器。進行資料複製時，可在一個網域中使用其他領域控制器。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-samba-server-sled" os="sled">
  <title>安裝 Samba 伺服器</title>
  <para>
   SUSE Linux Enterprise Desktop 上無法安裝 Samba 伺服器。如需安裝和設定 Samba 伺服器的資訊，請參閱《SUSE Linux Enterprise Server <citetitle>管理指南</citetitle>》。
  </para>
 </sect1>
 
 
 
 <sect1 xml:id="sec-samba-client-inst">
  <title>設定用戶端</title>

  <para>
   用戶端只能透過 TCP/IP 存取 Samba 伺服器。NetBEUI 與透過 IPX 的 NetBIOS 無法與 Samba 一起使用。
  </para>

  <sect2 xml:id="sec-samba-client-inst-yast">
   <title>使用 YaST 設定 Samba 用戶端</title>
   <para>
    設定 Samba 用戶端以存取 Samba 或 Windows 伺服器上的資源 (檔案或印表機)。在<menuchoice> <guimenu>網路服務</guimenu>
    <guimenu>Windows 網域成員</guimenu></menuchoice>對話方塊中輸入 NT 或 Active Directory 網域或工作群組。如果您啟用了<guimenu>Linux 驗證也使用 SMB 資訊</guimenu>，則使用者驗證將會在 Samba、NT 或 Kerberos 伺服器上執行。
   </para>
   <para>
    按一下<guimenu>進階設定</guimenu>可以指定進階組態選項。例如，使用<guimenu>安裝伺服器目錄</guimenu>表格可設定在驗證時自動掛接伺服器主目錄。這樣，使用者便可以存取其位於 CIFS 上的主目錄。如需詳細資訊，請參閱 <systemitem>pam_mount</systemitem> 的 man 頁面。
   </para>
   <para>
    完成所有設定之後，在對話方塊中進行確認以完成組態設定。
   </para>
  </sect2>
  <sect2 xml:id="sec-samba-client-old-server">
   <title>在用戶端上掛接 SMB1 共享</title>
   <para>
    第一個 SMB 網路通訊協定版本 SMB1 是一個不安全的早期通訊協定，現已由其策劃者 Microsoft 廢棄。出於安全原因，<command>SUSE Linux Enterprise Desktop</command> 上的 <phrase role="productname"><phrase os="sled">mount</phrase></phrase> 指令預設只會使用較新的通訊協定版本 (即 SMB 2.1、SMB 3.0 或 SMB 3.02) 掛接 SMB 共享。
   </para>
   <para>
    但是，此項變更只會影響透過 <filename>/etc/fstab</filename> 執行的 <command>mount</command> 指令和掛接操作。使用以下工具時，SMB1 預設仍然可用：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <command>smbclient</command> 工具。
     </para>
    </listitem>
    <listitem>
     <para>
      <phrase os="sles;sled">SUSE Linux Enterprise Server</phrase> 隨附的 Samba 伺服器軟體。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    在下面所述的設定中，由於只能使用 SMB1，此項預設設定會導致連接失敗：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      使用不支援較新 SMB 通訊協定版本之 SMB 伺服器的設定。自 Windows 7 和 Windows Server 2008 開始，Windows 提供 SMB 2.1 支援。
     </para>
    </listitem>
    <listitem>
     <para>
      依存於 SMB1/CIFS Unix 延伸的設定。這些延伸尚未移植至更高的通訊協定版本。
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>降低系統安全性</title>
    <para>
     遵循以下指示可以解決安全問題。如需這些問題的詳細資訊，請參閱 <link xlink:href="https://blogs.technet.microsoft.com/filecab/2016/09/16/stop-using-smb1/"/>。
    </para>
    <para>
     儘快升級伺服器以使用更安全的 SMB 版本。
    </para>
    
   </important>
   <para>
    如果您需要在目前的 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 核心中啟用 SMB1 共享，請將選項 <option>vers=1.0</option> 新增至所用的 <command>mount</command> 指令行中：
   </para>
   <screen><prompt role="root">root # </prompt>mount –t smbfs <replaceable>IP_ADDRESS</replaceable>:/<replaceable>SHARE</replaceable> /<replaceable>MOUNT_POINT</replaceable> –o username=<replaceable>USER_ID</replaceable>,workgroup=<replaceable>WORKGROUP_NAME</replaceable>,<emphasis role="bold">vers=1.0</emphasis></screen>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-anmeld-serv">
  <title>做為登入伺服器的 Samba</title>

  <para>
   在企業設定中，組織通常希望只允許已在中心例項上註冊的使用者進行存取。在以 Windows 為基礎的網路中，這個任務是由主要網域控制器 (PDC) 來處理。您可以使用已設定為 PDC 的 Windows NT 伺服器，但也可借助 Samba 伺服器完成此任務。在 <filename>smb.conf</filename> 的 <literal>[global]</literal> 區段中必須編輯的項目如 <xref linkend="dat-samba-smb-conf-dom"/> 所示。
  </para>

  <example xml:id="dat-samba-smb-conf-dom">
   <title>在 smb.conf 中的全域區段</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   需要準備符合 Winodws 加密格式的使用者帳戶與密碼。請使用 <command>smbpasswd</command> <option>-a name</option> 指令來執行此動作。使用下列指令為電腦建立網域帳戶 (Windows 網域概念所需)：
  </para>

<screen>useradd hostname
smbpasswd -a -m hostname</screen>

  <para>
   使用 <command>useradd</command> 指令，就會加上貨幣符號。當使用 <option>-m</option> 參數時，<command>smbpasswd</command> 指令就會自動插入這個符號。加備註的組態範例 (<filename>/usr/share/doc/packages/Samba/examples/smb.conf.SuSE</filename>) 包含一些設定，可讓此任務自動執行。
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m
     </screen>

  <para>
   為確保 Samba 可正確執行此程序檔，請選擇擁有所需之管理員權限的 Samba 使用者，並將其新增至 <systemitem class="groupname">ntadmin</systemitem> 群組。這樣就可以透過下列指令將 <literal>Domain Admin</literal> 狀態指定給此 Linux 群組內的所有使用者：
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 
 <sect1 xml:id="sec-samba-advanced">
  <title>進階主題</title>

  <para>
   本部分介紹用於管理 Samba 套裝軟體中用戶端部分與伺服器部分的進階方法。
  </para>

  <sect2 xml:id="sec-samba-advanced-compress">
   <title>Btrfs 上的透明檔案壓縮</title>
   <para>
    Samba 允許用戶端針對 Btrfs 檔案系統中的共用遠端操作檔案與目錄壓縮旗標。Windows 檔案總管可讓使用者透過<menuchoice><guimenu>檔案</guimenu><guimenu>內容</guimenu><guimenu>進階</guimenu></menuchoice>對話方塊來標識要進行透明壓縮的檔案/目錄：
   </para>
   <figure>
    <title>Windows 檔案總管<guimenu>進階屬性</guimenu>對話方塊</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    帶有壓縮旗標的檔案將以透明方式進行壓縮，當使用者存取或修改這些檔案時，基礎檔案系統會將其解壓縮。這通常可以節省儲存容量，不過，在存取檔案時會造成額外的 CPU 負擔。除非新檔案和目錄是使用 FILE_NO_COMPRESSION 選項建立的，否則，它們會繼承父目錄的壓縮旗標。
   </para>
   <para>
    Windows 檔案總管以不同的顯示區分壓縮檔案/目錄和未壓縮檔案/目錄：
   </para>
   <figure>
    <title>列有壓縮檔案的 Windows 檔案總管目錄</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    啟用 Samba 共用壓縮的方法有兩種，一種是手動將以下內容
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    新增至 <filename>/etc/samba/smb.conf</filename> 中的共用組態，另一種是使用 YaST：<menuchoice><guimenu>網路服務</guimenu><guimenu>Samba 伺服器</guimenu><guimenu>新增</guimenu></menuchoice>，然後核取<guimenu>使用 Btrfs 功能</guimenu>。
   </para>
   
  </sect2>

  <sect2 xml:id="sec-samba-advanced-snapshots">
   <title>快照</title>
   <para>
    快照也稱為陰影副本，是指某個檔案系統子磁碟區在某個特定時間點的狀態副本。在 Linux 中，使用 Snapper 工具來管理這些快照。Btrfs 檔案系統或簡易佈建的 LVM 磁碟區支援快照。Samba 套裝軟體支援透過伺服器端和用戶端的 FSRVP 通訊協定管理遠端快照。
   </para>
   <sect3 xml:id="sec-samba-advanced-snapshots-client">
    <title>先前版本</title>
    <para>
     Samba 伺服器上的快照可以做為檔案或目錄的先前版本公開給遠端 Windows 用戶端。
    </para>
    <para>
     若要在 Samba 伺服器上啟用快照，必須符合以下條件：
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       SMB 網路共用存放在 Btrfs 子磁碟區上。
      </para>
     </listitem>
     <listitem>
      <para>
       SMB 網路共用路徑中包含相關的 snapper 組態檔案。可以使用以下指令建立 snapper 檔案
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       如需有關 snapper 的詳細資訊，請參閱<xref linkend="cha-snapper"/>。
      </para>
     </listitem>
     <listitem>
      <para>
       必須允許相關使用者存取快照目錄樹。如需詳細資訊，請參閱 vfs_snapper 手冊頁 (<command>man 8 vfs_snapper</command>) 的PERMISSIONS (許可權) 部分。
      </para>
     </listitem>
    </itemizedlist>
    <para>
     若要支援遠端快照，需要修改 <filename>/etc/samba/smb.conf</filename> 檔案。若要完成此操作，您可以選取<menuchoice><guimenu>YaST</guimenu><guimenu>網路服務</guimenu><guimenu>Samba 伺服器</guimenu></menuchoice>，或者使用以下指令手動增強相關的共用區段
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     請注意，您需要重新啟動 Samba 服務後，對 <filename>smb.conf</filename> 所做的手動變更才能生效：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> systemctl restart nmb smb</screen>
    <figure xml:id="fig-yast2-samba-snapshot">
     <title>在啟用快照的情況下新增 Samba 共用</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     經過設定後，可以透過 Windows 檔案總管中某個檔案或目錄之<guimenu>以前的版本</guimenu>索引標籤存取由 snapper 針對 Samba 共用路徑建立的快照。
    </para>
    <figure xml:id="fig-samba-win-explorer">
     <title>Windows 檔案總管中的<guimenu>以前的版本</guimenu>索引標籤</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-server">
    <title>遠端共用快照</title>
    <para>
     依預設，只能在 Samba 伺服器本地透過 snapper 指令行公用程式或者使用 snapper 時間線功能來建立和刪除快照。
    </para>
    <para>
     可將 Samba 設定為使用檔案伺服器遠端 VSS 通訊協定 (File Server Remote VSS Protocol，FSRVP) 來處理來自遠端主機的共用快照建立和刪除要求。
    </para>
    <para>
     除了<xref linkend="sec-samba-advanced-snapshots-client"/>中所述的組態和先決條件以外，還需要在 <filename>/etc/samba/smb.conf</filename> 中設定以下全域組態：
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     然後，FSRVP 用戶端 (包括 Samba 的 <command>rpcclient</command> 以及 Windows Server 2012 的 <command>DiskShadow.exe</command>) 便可以指示 Samba 為指定的共用建立或刪除快照，並將該快照公開為新共用。
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-linux">
    <title>使用 <command>rpcclient</command> 從 Linux 遠端管理快照</title>
    <para>
     <systemitem>samba-client</systemitem> 套件中有一個 FSRVP 用戶端，它可以遠端要求 Windows/Samba 伺服器建立並公開指定共用的快照。然後，您可以使用 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 中的現有工具掛接公開的共用，並備份其檔案。向伺服器發出的要求將使用 <command>rpcclient</command> 二進位檔案傳送。
    </para>
    <example>
     <title>使用 <command>rpcclient</command> 要求 Windows Server 2012 共用快照</title>
     <para>
      以 <literal>EXAMPLE</literal> 網域中管理員的身分連接到 <literal>win-server.example.com</literal> 伺服器：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      檢查 SMB 共用是否對 <command>rpcclient</command> 可見：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      檢查 SMB 共用是否支援建立快照：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      要求建立共用快照：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      確認伺服器是否已公開快照共用：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      嘗試刪除快照共用：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      確認伺服器是否已移除快照共用：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-winserver">
    <title>使用 <command>DiskShadow.exe</command> 從 Windows 遠端管理快照</title>
    <para>
     您也可以在充當用戶端的 Windows 環境中管理 Linux Samba 伺服器上 SMB 共用的快照。Windows Server 2012 提供了 <command>DiskShadow.exe</command> 公用程式，該公用程式可以如<xref linkend="sec-samba-advanced-snapshots-client-linux"/>中所述的 <command>rpcclient</command> 那樣管理遠端共用。請注意，首先您需要妥善設定 Samba 伺服器。
    </para>
    <para>
     以下範例程序說明了如何設定 Samba 伺服器，使 Windows Server 用戶端能夠管理其共用的快照。請注意，<replaceable>EXAMPLE</replaceable> 是在測試環境中使用的 Active Directory 網域，
     <uri>fsrvp-server.example.com</uri> 是 Samba 伺服器的主機名稱，<filename>/srv/smb</filename> 是 SMB 共享的路徑。
    </para>
    <procedure>
     <title>Samba 伺服器組態設定詳細說明</title>
     <step>
      <para>
       透過 YaST 加入到 Active Directory 網域。
      </para>
     </step>
     <step>
      <para>
       確定「使用中網域 DNS」項目正確無誤：
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step>
      <para>
       在 <filename>/srv/smb</filename> 位置建立 Btrfs 子磁碟區
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step>
      <para>
       為路徑 <filename>/srv/smb</filename> 建立 snapper 組態檔案
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step>
      <para>
       建立路徑為 <filename>/srv/smb</filename> 的新共用，並啟用 YaST 的<guimenu>公開快照</guimenu>核取方塊。確定將以下片段新增到 <filename>/etc/samba/smb.conf</filename> 中的 global 部分，如<xref linkend="sec-samba-advanced-snapshots-server"/>中所述：
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step>
      <para>
       使用 <command>systemctl restart nmb smb</command> 重新啟動 Samba
      </para>
     </step>
     <step>
      <para>
       設定 snapper 許可權：
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       確定也允許任何 ALLOW_USERS 瀏覽 <filename>.snapshots</filename> 子目錄。
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>路徑逸出</title>
       <para>
        請注意「\」逸出！請逸出兩次，以確定 <filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename> 中儲存的值逸出一次。
       </para>
      </important>
      <para>
       "EXAMPLE\win-client$" 對應於 Windows 用戶端電腦帳戶。對此帳戶進行驗證後，Windows 將發出初始 FSRVP 要求。
      </para>
     </step>
     <step>
      <para>
       授予 Windows 用戶端帳戶必要的權限：
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       不需要對 "EXAMPLE\Administrator" 使用者執行上一條指令，因為已授予該使用者權限。
      </para>
     </step>
    </procedure>
    <procedure>
     <title>執行 Windows 用戶端設定和 <command>DiskShadow.exe</command></title>
     <step>
      <para>
       開機 Windows Server 2012 (範例主機名稱為 WIN-CLIENT)。
      </para>
     </step>
     <step>
      <para>
       就像在 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 上一般，加入到同一個 Active Directory 網域 EXAMPLE。
      </para>
     </step>
     <step>
      <para>
       重新開機。
      </para>
     </step>
     <step>
      <para>
       開啟 Powershell。
      </para>
     </step>
     <step>
      <para>
       啟動 <command>DiskShadow.exe</command>，然後開始執行備份程序：
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step>
      <para>
       指定每次程式離開、重設或重新開機時要保留的陰影副本：
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step>
      <para>
       檢查指定的共用是否支援快照，然後建立一個快照：
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name:
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step>
      <para>
       完成備份程序：
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step>
      <para>
       建立快照後，嘗試將它刪除，並驗證刪除結果：
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-info">
  <title>更多資訊</title>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>線上文件：</title>
     <para>
      若要查看與套件
      <package>samba</package>一同安裝的所有 man 頁面清單，請執行 <command>apropos samba</command>。使用 <command>man <replaceable>man 頁面名稱</replaceable></command>開啟任一 man 頁面。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>SUSE 特定的讀我檔案：</title>
     <para>
      套件 <package>samba-client</package> 包含檔案 <filename>/usr/share/doc/packages/samba/README.SUSE</filename>。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>其他套裝文件：</title>
     <para>
      使用 <command>zypper install samba-doc</command> 安裝 <systemitem>samba-doc</systemitem> 套件。
     </para>
    </formalpara>
    <para>
     此文件將安裝到 <filename>/usr/share/doc/packages/samba</filename> 中。其中包含 HTML 版本的 man 頁面以及範例組態文件庫 (例如 <filename>smb.conf.SUSE</filename>)。
    </para>
   </listitem>
   <listitem>
    <formalpara>
     <title>線上文件：</title>
     <para>
      <link xlink:href="https://wiki.samba.org/index.php/User_Documentation"/> 上的 Samba Wiki 包含詳細的<citetitle>使用者文件</citetitle>。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
