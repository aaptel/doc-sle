<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_nfs.xml" version="5.0" xml:id="cha-nfs">
 <title>使用 NFS 共享檔案系統</title>
 <info>
  <abstract>
   <para>
    <emphasis>網路檔案系統</emphasis> (<emphasis>NFS</emphasis>) 是允許存取伺服器上檔案的通訊協定，存取方式與存取本地檔案相似。
   </para>
       <para>
   SUSE Linux Enterprise Server SP1 會安裝 NFS v4.2，後者引入了對疏鬆檔案、檔案預先配置、伺服器端複製、應用程式資料區塊 (ADB) 和適用於強制性存取控制 (MAC) 的帶標籤 NFS (用戶端和伺服器上均需要 MAC) 的支援。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>是</dm:translation>
  </dm:docmanager>
 </info>

 <sect1 xml:id="sec-nfs-overview">
  <title>綜覽</title>
  <para>
   <emphasis>網路檔案系統</emphasis> (NFS) 是經過充分證明且受到廣泛支援的標準化網路通訊協定，它允許在單獨的主機之間共用檔案。
  </para>
  <para>
   <emphasis>網路資訊服務</emphasis> (NIS) 可用於在網路中進行集中式使用者管理。將 NFS 和 NIS 結合使用，可透過檔案和目錄權限在網路中進行存取控制。NFS 與 NIS 攜手能讓使用者對網路有清楚的瞭解。
  </para>
  <para>
   在預設組態中，NFS 完全信任網路，因此會信任連接到可信網路的任何機器。在可透過實體方式存取 NFS 伺服器所信任的任何網路的任何電腦上，任何具有管理員特權的使用者都可以存取該伺服器提供的所有檔案。
  </para>
  <para>
   一般而言，此安全性層級非常適合以下情形：所信任的網路是真正的私人網路，通常局限於單個機櫃或機房，並且無法進行未經授權的存取。將整個子網路做為一個整體信任的其他情形限制較多，需要更精密的信任機制。為了符合這些情形的需要，NFS 使用 <emphasis>Kerberos</emphasis> 基礎架構來支援各種安全性層級。Kerberos 需要 NFSv4 (預設使用該通訊協定)。如需詳細資料，請參閱<xref linkend="cha-security-kerberos"/>。
  </para>

  <para>
   YaST 模組中使用了下列詞彙。
  </para>

  <variablelist>
   <varlistentry>
    <term>輸出</term>
    <listitem>
     <para>
      由 NFS 伺服器<emphasis>輸出</emphasis>的目錄，用戶端可將該目錄整合到其系統中。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 用戶端</term>
    <listitem>
     <para>
      NFS 用戶端是指透過「網路檔案系統」通訊協定使用 NFS 伺服器提供之 NFS 服務的系統。TCP/IP 通訊協定已整合到 Linux 核心中；不需要安裝任何其他軟體。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 伺服器</term>
    <listitem>
     <para>
      NFS 伺服器向用戶端提供 NFS 服務。執行中的伺服器依賴於以下精靈運作：<systemitem class="daemon">nfsd</systemitem> (worker)、<systemitem class="daemon">idmapd</systemitem> (用於 NFSv4 的 ID 到名稱映射，僅在某些情境下需要)、<systemitem class="daemon">statd</systemitem> (檔案鎖定) 和 <systemitem class="daemon">mountd</systemitem> (掛接要求)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv3</term>
    <listitem>
     <para>
      NFSv3 是第 3 版實作，即支援用戶端驗證的<quote>舊</quote>無狀態 NFS。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv4</term>
    <listitem>
     <para>
      NFSv4 是新版 (第 4 版) 實作，支援透過 Kerberos 的安全使用者驗證。NFSv4 只需要一個連接埠，因此比 NFSv3 更適合在防火牆後的環境中使用。
     </para>
     <para>
      協定的定義如 <link xlink:href="http://tools.ietf.org/html/rfc3530"/> 所示。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>pNFS</term>
    <listitem>
     <para>
      平行 NFS，NFSv4 的通訊協定延伸。所有 pNFS 用戶端都可以直接存取 NFS 伺服器上的資料。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  
 </sect1>

 <sect1 os="sled" xml:id="sec-nfs-installation-sled">


  <title>安裝 NFS 伺服器</title>

  <para>
   若要安裝和設定 NFS 伺服器，請參閱相應的 SUSE Linux Enterprise Server 文件。
  </para>
 </sect1>

 
 
 <sect1 xml:id="sec-nfs-configuring-nfs-clients">
  <title>設定用戶端</title>

  <para>
   您不需安裝其他軟體就能將您的主機設定為 NFS 用戶端。所有需要的套件預設都會安裝。
  </para>

  <sect2 xml:id="sec-nfs-import-yast2">
   <title>以 YaST 輸入檔案系統</title>
   <para>
    授權使用者可以使用 YaST NFS 用戶端模組將NFS 目錄從 NFS 伺服器掛接到本地檔案樹。請執行下列步驟：
   </para>
   <procedure xml:id="pro-nfs-import-yast2">
    <title>輸入 NFS 目錄</title>
    <step>
     <para>
      啟動 YaST NFS 用戶端模組。
     </para>
    </step>

    <step>
     <para>
      在<guimenu>NFS 共用</guimenu>索引標籤中按一下<guimenu>新增</guimenu>。輸入 NFS 伺服器的主機名稱、要輸入的目錄和在本地掛接此目錄的掛接點。
     </para>
    </step>


    <step>
     <para>
      使用 NFSv4 時，在<guimenu>NFS 設定</guimenu>標籤中選取 <guimenu>啟用 NFSv4</guimenu>。另外，<guimenu>NFSv4 網域名稱</guimenu>必須包含 NFSv4 伺服器所用的相同值。預設網域為 <literal>localdomain</literal>。
     </para>
    </step>
    <step>
     <para>
      若要為 NFS 使用 Kerberos 驗證，則 GSS 安全性必須啟用。選取<guimenu>啟用 GSS 安全性</guimenu>。
     </para>
    </step>
    <step>
     <para>
      如果您要使用防火牆並希望允許遠端電腦存取服務，請啟用<guimenu>NFS 設定</guimenu>索引標籤中的<guimenu>在防火牆中開啟埠</guimenu>。防火牆的狀態顯示於核取方塊旁。
     </para>
    </step>

    <step>
     <para>
      按一下<guimenu>確定</guimenu>，儲存變更。
     </para>
    </step>
   </procedure>
   <para>
    組態將會寫入 <filename>/etc/fstab</filename> 中，並會掛接指定的檔案系統。當您稍後啟動 YaST 組態用戶端時，它也會從這個檔案讀取現有組態。
   </para>
   <tip>
    <title>用做根檔案系統的 NFS</title>
    <para>
     在透過網路將根分割區掛接為 NFS 共用的 (無磁碟) 系統中，設定可用於存取 NFS 共用的網路裝置時需特別小心。
    </para>
    <para>
     將系統關閉或重新開機時，預設的處理順序是先關閉網路連接，然後卸載根分割區。對於 NFS 根分割區，這種順序會造成問題，因為在尚未與 NFS 共用啟動網路連接的情況下，根分割區無法完全卸載。為防止系統停用相關的網路裝置，請依<xref linkend="sec-network-yast-change-start"/>中所述開啟網路裝置組態索引標籤，然後在<guimenu>裝置啟動</guimenu>窗格中選取<guimenu>在 NFSroot 時</guimenu>。
    </para>
   </tip>

  </sect2>

  <sect2 xml:id="sec-nfs-import">
   <title>手動輸入檔案系統</title>


   <para>
    從 NFS 伺服器手動輸入檔案系統的先決條件是有 RPC 埠對應程式正在執行。<option>nfs</option> 服務負責正確啟動該程式；因此，請以 <systemitem class="username">root</systemitem> 身分輸入 <command>systemctl start nfs</command>，以啟動該服務。接著，可以像處理本地分割區一樣，使用 <command>mount</command> 指令在檔案系統中掛接遠端檔案系統：
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount <replaceable>HOST</replaceable>:<replaceable>REMOTE-PATH</replaceable><replaceable>LOCAL-PATH</replaceable></screen>
   <para>
    例如，若要從 <systemitem>nfs.example.com</systemitem> 機器輸入使用者目錄，可以使用：
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount nfs.example.com:/home /home</screen>
   <sect3 xml:id="sec-nfs-automount">
    <title>使用自動裝載服務</title>
    <para>
     autofs 精靈可用於自動掛接遠端檔案系統。請將下列項目加入 <filename>/etc/auto.master</filename> 檔案：
    </para>
<screen>/nfsmounts /etc/auto.nfs</screen>
    <para>
     如果能正確填入 <filename>auto.nfs</filename> 檔案，<filename>/nfsmounts</filename> 目錄此後便會成為用戶端上所有 NFS 掛接作業的根部。選擇 <filename>auto.nfs</filename> 這個名稱是從方便角度考量，您可以自行選擇任何名稱。使用以下指令在 <filename>auto.nfs</filename> 中為所有 NFS 掛接作業新增項目：
    </para>
<screen>localdata -fstype=nfs server1:/data
nfs4mount -fstype=nfs4 server2:/</screen>
    <para>
     以 <systemitem class="username">root</systemitem> 身分執行 <command>systemctl start autofs</command> 以啟動設定。在此範例中，<systemitem>server1</systemitem> 的 <filename>/data</filename> 目錄 <filename>/nfsmounts/localdata</filename> 會掛接 NFS，而 <systemitem>server2</systemitem> 的 <filename>/nfsmounts/nfs4mount</filename> 會掛接 NFSv4。
    </para>
    <para>
     如果在 autofs 服務執行期間有程式編輯了 <filename>/etc/auto.master</filename> 檔案，則必須使用 <command>systemctl restart autofs</command> 重新啟動自動掛載器，才能使變更生效。
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-fstab">
    <title>手動編輯 <filename>/etc/fstab</filename></title>
    <para>
     <filename>/etc/fstab</filename> 中典型的 NFSv3 掛接項目如下：
    </para>
<screen>nfs.example.com:/data /local/path nfs rw,noauto 0 0</screen>
    <para>
     對於 NFSv4 掛接，請在第三欄中使用 <literal>nfs4</literal> 而不是 <literal>nfs</literal>：
    </para>
<screen>nfs.example.com:/data /local/pathv4 nfs4 rw,noauto 0 0</screen>
    <para>
     <literal>noauto</literal> 選項可防止在啟動時自動掛接檔案系統。如果要手動掛接各檔案系統，可以縮短掛接指令的長度，僅指定掛接點：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount /local/path</screen>
    <note>
     <title>啟動時掛接</title>
     <para>
      請注意，如果未輸入 <literal>noauto</literal> 選項，系統的 init 程序檔會在啟動時處理這些檔案系統的掛接。
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-nfs-pnfs">
   <title>平行 NFS (pNFS)</title>
   <para>
    NFS 是最舊的通訊協定之一，開發於八十年代。雖然如此，NFS 對於共用小型檔案還是綽綽有餘的。但是，當您要傳輸大型檔案或有大量的用戶端要存取資料時，NFS 伺服器會成為瓶頸，嚴重影響系統效能。出現這種情況的原因是檔案大小快速變大，而乙太網路的相對速度無法完全跟上這一變化。
   </para>
   <para>
    當您向一般 NFS 伺服器要求檔案時，伺服器會尋找檔案中繼資料、收集所有資料，並透過網路將資料傳輸到您的用戶端。但是，不論檔案的大小，效能瓶頸都會變得很明顯：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      對於小型檔案，大部分時間都用在收集中繼資料上.
     </para>
    </listitem>
    <listitem>
     <para>
      對於大型檔案，大部分時間則用在將資料從伺服器傳輸至用戶端上。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    pNFS (或平行 NFS) 克服了這個局限性，因為它將檔案系統中繼資料與資料位置分隔開來。因此，pNFS 需要兩種類型的伺服器：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      <emphasis>中繼資料</emphasis>或<emphasis>控制伺服器</emphasis>，用於處理所有非資料流量
     </para>
    </listitem>
    <listitem>
     <para>
      一或多個<emphasis>儲存伺服器</emphasis>，用於存放資料
     </para>
    </listitem>
   </itemizedlist>
   <para>
    中繼資料與儲存伺服器構成了一個邏輯 NFS 伺服器。當用戶端想要讀取或寫入時，中繼資料伺服器會告知 NFSv4 用戶端使用哪個儲存伺服器來存取檔案區塊。用戶端可以直接存取伺服器上的資料。
   </para>
   <para>
    <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 僅在用戶端上支援 pNFS。
   </para>
   <sect3 xml:id="sec-nfs-pnfs-yast">
    <title>使用 YaST 設定 pNFS 用戶端</title>
    <para>
     依<xref linkend="pro-nfs-import-yast2"/> 中所示繼續操作，但要按一下<guimenu>pNFS (v4.2)</guimenu>核取方塊並選擇性地按一下<guimenu>NFSv4 共享</guimenu>。YaST 會執行所有必要的步驟，並將所有需要的選項寫入檔案 <filename>/etc/exports</filename>。
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-pnfs-manual">
    <title>手動設定 pNFS 用戶端</title>
    <para>
     請參閱<xref linkend="sec-nfs-import"/> 開始設定。大部分組態均由 NFSv4 伺服器執行。對於 pNFS，唯一的差異是將 <option>minorversion</option> 選項和中繼資料伺服器 <replaceable>MDS 伺服器</replaceable>新增至 <command>mount</command> 指令：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount -t nfs4 -o minorversion=1 <replaceable>MDS_SERVER</replaceable> <replaceable>MOUNTPOINT</replaceable></screen>
    <para>
     為了協助進行除錯，請在 <filename>/proc</filename> 檔案系統中變更該值：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> echo 32767 &gt; /proc/sys/sunrpc/nfsd_debug
<prompt>tux &gt; </prompt><command>sudo</command> echo 32767 &gt; /proc/sys/sunrpc/nfs_debug</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-nfs-info">
  <title>更多資訊</title>
  <para>
   除了 <command>exports</command>、<command>nfs</command> 和 <command>mount</command> 的 man 頁面以外，<filename>/usr/share/doc/packages/nfsidmap/README</filename> 中也提供了有關設定 NFS 伺服器和用戶端的資訊。如需更多線上文件，請參閱下列網站：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     如需詳細的線上技術文件，請造訪 <link xlink:href="http://nfs.sourceforge.net/">SourceForge</link>。
    </para>
   </listitem>
   <listitem>
    <para>
     如需設定已監督之 NFS 的指示，請參閱 <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/krb5-setup.html">NFS 第 4 版開放原始碼實作參考</link>。
    </para>
   </listitem>
   <listitem>
    <para>
     如果您有任何關於 NFSv4 的問題，請參閱 <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/faq/">Linux NFSv4 常見問答集</link>。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
