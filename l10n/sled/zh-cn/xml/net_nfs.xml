<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_nfs.xml" version="5.0" xml:id="cha-nfs">
 <title>通过 NFS 共享文件系统</title>
 <info>
  <abstract>
   <para>
    <emphasis>网络文件系统</emphasis> (<emphasis>NFS</emphasis>) 是允许访问服务器上的文件的协议，访问方式与访问本地文件相似。
   </para>
       <para>
   SUSE Linux Enterprise Server SP1 会安装 NFS v4.2，后者引入了对稀疏文件、文件预分配、服务器端克隆和复制、应用程序数据块 (ADB) 和用于强制性访问控制 (MAC) 的带标签 NFS（客户端和服务器上均需要 MAC）的支持。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>是</dm:translation>
  </dm:docmanager>
 </info>

 <sect1 xml:id="sec-nfs-overview">
  <title>概述</title>
  <para>
   <emphasis>网络文件系统</emphasis> (NFS) 是久经考验且广泛支持的标准化网络协议，它允许在单独的主机之间共享文件。
  </para>
  <para>
   <emphasis>网络信息服务</emphasis> (NIS) 可用于在网络中进行集中式用户管理。将 NFS 和 NIS 结合使用可通过文件和目录权限在网络中进行访问控制。NFS 与 NIS 一起使用时网络面向用户是透明的。
  </para>
  <para>
   在默认配置中，NFS 完全信任网络，因此会信任连接到可信网络的任何计算机。在可通过物理方式访问 NFS 服务器所信任的任何网络的任何计算机上，任何具有管理员特权的用户都可以访问该服务器提供的所有文件。
  </para>
  <para>
   一般而言，此安全性级别非常适于以下情形：所信任的网络是真正的专用网络，通常局限于单个计算机机柜或机房，并且无法进行未经授权的访问。将整个子网作为一个整体信任的其他情形限制较多，需要更精密的信任机制。为了满足这些情形的需要，NFS 使用 <emphasis>Kerberos</emphasis> 基础架构来支持各种安全性级别。Kerberos 需要 NFSv4（默认使用该协议）。有关细节，请参见<xref linkend="cha-security-kerberos"/>。
  </para>

  <para>
   下面是 YaST 模块中使用的术语。
  </para>

  <variablelist>
   <varlistentry>
    <term>导出</term>
    <listitem>
     <para>
      由 NFS 服务器<emphasis>导出</emphasis>的目录，客户端可将其集成到系统中。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 客户端</term>
    <listitem>
     <para>
      NFS 客户端是通过网络文件系统协议使用来自 NFS 服务器的 NFS 服务的系统。TCP/IP 协议已集成到 Linux 内核中；无需再安装任何其他软件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 服务器</term>
    <listitem>
     <para>
      NFS 服务器向客户端提供 NFS 服务。运行中的服务器依赖于以下守护程序：<systemitem class="daemon">nfsd</systemitem> (worker)、<systemitem class="daemon">idmapd</systemitem>（用于 NFSv4 的 ID 到名称映射，仅在某些场景下需要）、<systemitem class="daemon">statd</systemitem>（文件锁定）和 <systemitem class="daemon">mountd</systemitem>（装入请求）。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv3</term>
    <listitem>
     <para>
      NFSv3 是版本 3 实施，支持客户端身份验证的<quote>旧版</quote>无状态 NFS。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv4</term>
    <listitem>
     <para>
      NFSv4 是新的版本 4 实施，支持通过 Kerberos 进行安全用户身份验证。NFSv4 只需要一个端口，因此，它比 NFSv3 更适合用于防火墙后的环境。
     </para>
     <para>
      协议指定为 <link xlink:href="http://tools.ietf.org/html/rfc3530"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>pNFS</term>
    <listitem>
     <para>
      并行 NFS，属于 NFSv4 的一种协议扩展。任何 pNFS 客户端都可以直接访问 NFS 服务器上的数据。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  
 </sect1>

 <sect1 os="sled" xml:id="sec-nfs-installation-sled">


  <title>安装 NFS 服务器</title>

  <para>
   要安装和配置 NFS 服务器，请参见相应的 SUSE Linux Enterprise Server 文档。
  </para>
 </sect1>

 
 
 <sect1 xml:id="sec-nfs-configuring-nfs-clients">
  <title>配置客户端</title>

  <para>
   要将主机配置为 NFS 客户端，无需安装其他软件。将默认安装所有需要的包。
  </para>

  <sect2 xml:id="sec-nfs-import-yast2">
   <title>使用 Yast 导入文件系统</title>
   <para>
    授权用户可以用 YaST NFS 客户端模块从 NFS 服务器将 NFS 目录装入本地文件树。按如下所示继续：
   </para>
   <procedure xml:id="pro-nfs-import-yast2">
    <title>导入 NFS 目录</title>
    <step>
     <para>
      启动 YaST NFS 客户端模块。
     </para>
    </step>

    <step>
     <para>
      单击 <guimenu>NFS 共享</guimenu>选项卡中的<guimenu>添加</guimenu>。输入 NFS 服务器的主机名、要导入的目录以及要在本地的哪个装入点装入此目录。
     </para>
    </step>


    <step>
     <para>
      使用 NFSv4 时，在 <guimenu>NFS 设置</guimenu>选项卡中选择<guimenu>启用 NFSv4</guimenu>。另外，<guimenu>NFSv4 域名</guimenu>必须包含 NFSv4 服务器所用的相同值。默认域为 <literal>localdomain</literal>。
     </para>
    </step>
    <step>
     <para>
      要对 NFS 使用 Kerberos 身份验证，必须启用 GSS 安全性。选择<guimenu>启用 GSS 安全</guimenu>。
     </para>
    </step>
    <step>
     <para>
      若要使用防火墙并允许从远程计算机访问服务，请启用 <guimenu>NFS 设置</guimenu>选项卡中的<guimenu>打开防火墙中的端口</guimenu>。防火墙状态将显示在复选框旁边。
     </para>
    </step>

    <step>
     <para>
      单击<guimenu>确定</guimenu>保存更改。
     </para>
    </step>
   </procedure>
   <para>
    配置写入<filename>/etc/fstab</filename>，并将装入指定的文件系统。当您稍后启动 YaST 配置客户端时，它还将读取此文件中的现有配置。
   </para>
   <tip>
    <title>NFS 用作根文件系统</title>
    <para>
     在通过网络以 NFS 共享形式装入根分区的（无磁盘）系统中，配置可用来访问 NFS 共享的网络设备时需特别小心。
    </para>
    <para>
     关闭或重引导系统时，默认的处理顺序是关闭网络连接，然后卸载根分区。对于 NFS 根分区，这种顺序会产生问题，因为在尚未激活与 NFS 共享的网络连接的情况下，根分区无法完全卸载。为防止系统停用相关的网络设备，请按<xref linkend="sec-network-yast-change-start"/>中所述打开网络设备配置选项卡，然后在<guimenu>设备激活</guimenu>窗格中选择<guimenu>通过 NFSroot</guimenu>。
    </para>
   </tip>

  </sect2>

  <sect2 xml:id="sec-nfs-import">
   <title>手动导入文件系统</title>


   <para>
    手动从 NFS 服务器导入文件系统的先决条件是运行 RPC 端口映射器。<option>nfs</option> 服务负责正确启动该程序；因此，请以 <systemitem class="username">root</systemitem> 身份输入 <command>systemctl start nfs</command> 来启动该服务。然后就可以使用 <command>mount</command> 将远程文件系统像本地分区那样装入文件系统中：
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount <replaceable>HOST</replaceable>:<replaceable>REMOTE-PATH</replaceable><replaceable>LOCAL-PATH</replaceable></screen>
   <para>
    例如，要从 <systemitem>nfs.example.com</systemitem> 计算机导入用户目录，请使用：
   </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount nfs.example.com:/home /home</screen>
   <sect3 xml:id="sec-nfs-automount">
    <title>使用自动装入服务</title>
    <para>
     autofs 守护程序可用于自动装入远程文件系统。请在 <filename>/etc/auto.master</filename> 文件中添加以下条目：
    </para>
<screen>/nfsmounts /etc/auto.nfs</screen>
    <para>
     如果 <filename>auto.nfs</filename> 文件正确填充，<filename>/nfsmounts</filename> 目录将作为客户端上所有 NFS 装入的 root 目录。选择 <filename>auto.nfs</filename> 这个名称是为了方便起见，您可以选择任何名称。在 <filename>auto.nfs</filename> 中为所有 NFS 装入添加条目，如下所示：
    </para>
<screen>localdata -fstype=nfs server1:/data
nfs4mount -fstype=nfs4 server2:/</screen>
    <para>
     以 <systemitem class="username">root</systemitem> 身份运行 <command>systemctl start autofs</command> 来激活该设置。对于此示例，<filename>/nfsmounts/localdata</filename>，<systemitem>server1</systemitem> 的 <filename>/data</filename> 目录将通过 NFS 装入，<systemitem>server2</systemitem> 的 <filename>/nfsmounts/nfs4mount</filename> 将通过 NFSv4 装入。
    </para>
    <para>
     如果在 autofs 服务正在运行时编辑了 <filename>/etc/auto.master</filename> 文件，则必须使用 <command>systemctl restart autofs</command> 重启动自动装载器才能使更改生效。
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-fstab">
    <title>手动编辑 <filename>/etc/fstab</filename></title>
    <para>
     通常，<filename>/etc/fstab</filename> 中的 NFSv3 装入项如下：
    </para>
<screen>nfs.example.com:/data /local/path nfs rw,noauto 0 0</screen>
    <para>
     对于 NFSv4 装入，请在第三列中使用 <literal>nfs4</literal> 而不是 <literal>nfs</literal>：
    </para>
<screen>nfs.example.com:/data /local/pathv4 nfs4 rw,noauto 0 0</screen>
    <para>
     <literal>noauto</literal> 选项可禁止在启动时自动装入文件系统。如果您要手动安装各文件系统，可以缩短只指定安装点的安装命令：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount /local/path</screen>
    <note>
     <title>启动时装入</title>
     <para>
      如果您没有输入 <literal>noauto</literal> 选项，系统的 init 脚本将在启动时处理这些文件系统的装入。
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-nfs-pnfs">
   <title>并行 NFS (pNFS)</title>
   <para>
    NFS 是最老的协议之一，开发于上世纪八十年代。因此，如果您要共享小文件，NFS 通常能够满足需求。但是，当您要传送大文件或有大量的客户端要访问数据时，NFS 服务器会成为瓶颈，严重影响系统性能。这是因为文件迅速变大，而以太网的相对速度没有完全跟上这一变化。
   </para>
   <para>
    当您向普通 NFS 服务器请求文件时，服务器会查找文件元数据、收集所有数据并通过网络将数据传送到您的客户端。但是，无论文件的大小如何，性能瓶颈都会凸显出来：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      如果是小文件，则大部分时间都花在收集元数据上。
     </para>
    </listitem>
    <listitem>
     <para>
      如果是大文件，则大部分时间花在将数据从服务器传送到客户端上。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    pNFS 或并行 NFS 则突破了此种限制，因为它将文件系统元数据从数据位置分离出来。因此，pNFS 需要两类服务器：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      一个<emphasis>元数据</emphasis>或<emphasis>控制服务器</emphasis>，用于处理所有非数据通讯
     </para>
    </listitem>
    <listitem>
     <para>
      一个或多个<emphasis>储存服务器</emphasis>，用于存放数据
     </para>
    </listitem>
   </itemizedlist>
   <para>
    元数据和储存服务器组成单独一个逻辑 NFS 服务器。当客户端要读取或写入时，元数据服务器会告诉 NFSv4 客户端使用哪个储存服务器访问文件块。客户端可以直接访问该服务器上的数据。
   </para>
   <para>
    <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 仅在客户端上支持 pNFS。
   </para>
   <sect3 xml:id="sec-nfs-pnfs-yast">
    <title>使用 YaST 配置 pNFS 客户端</title>
    <para>
     请执行<xref linkend="pro-nfs-import-yast2"/>中所述的步骤，但选中 <guimenu>pNFS (v4.2)</guimenu> 复选框以及可选的 <guimenu>NFSv4 共享</guimenu>。YaST 会执行所有必需的步骤，并且会在文件 <filename>/etc/exports</filename> 中写入所有必要选项。
    </para>
   </sect3>
   <sect3 xml:id="sec-nfs-pnfs-manual">
    <title>手动配置 pNFS 客户端</title>
    <para>
     请参阅<xref linkend="sec-nfs-import"/>着手配置。大多数配置通过 NFSv4 服务器完成。对于 pNFS，唯一的区别是将 <option>minorversion</option> 选项和元数据服务器 <replaceable>MDS_服务器</replaceable>添加到您的 <command>mount</command> 命令：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> mount -t nfs4 -o minorversion=1 <replaceable>MDS_SERVER</replaceable> <replaceable>MOUNTPOINT</replaceable></screen>
    <para>
     为方便调试，请更改 <filename>/proc</filename> 文件系统中的值：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> echo 32767 &gt; /proc/sys/sunrpc/nfsd_debug
<prompt>tux &gt; </prompt><command>sudo</command> echo 32767 &gt; /proc/sys/sunrpc/nfs_debug</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-nfs-info">
  <title>更多信息</title>
  <para>
   除了 <command>exports</command>、<command>nfs</command> 和 <command>mount</command> 的手册页外，还可在 <filename>/usr/share/doc/packages/nfsidmap/README</filename> 中找到关于配置 NFS 服务器和客户端的信息。有关更多联机文档，请参见以下网站：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     在 <link xlink:href="http://nfs.sourceforge.net/">SourceForge</link> 上联机查找详细的技术文档。
    </para>
   </listitem>
   <listitem>
    <para>
     关于设置采用 Kerberos 的 NFS 的描述，请参见 <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/krb5-setup.html">NFS Version 4 Open Source Reference Implementation</link>。
    </para>
   </listitem>
   <listitem>
    <para>
     如果您对 NFSv4 有疑问，请参考 <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/faq/">Linux NFSv4 FAQ</link>（Linux NFSv4 常见问题）。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
