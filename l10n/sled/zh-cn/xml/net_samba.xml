<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="net_samba.xml" version="5.0" xml:id="cha-samba">
 <title>Samba</title>
 <info>
  <abstract>
   <para>
    使用 Samba 可以将 Unix 计算机配置为 macOS、Windows 和 OS/2 计算机的文件和打印服务器。Samba 已经发展成为一个功能完备且相当复杂的产品。使用 YaST 或手动编辑配置文件来配置 Samba。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-samba-term">
  <title>术语</title>

  <para>
   以下是 Samba 文档和 YaST 模块中使用的一些术语。
  </para>

  <variablelist>
   <varlistentry>
    <term>SMB 协议</term>
    <listitem>
     <para>
      Samba 使用基于 <phrase role="productname">NetBIOS</phrase> 服务的 SMB（服务器讯息块）协议。Microsoft 发布该协议以便其他软件制造商能够与 Microsoft 域网络建立连接。使用 Samba 时，SMB 协议在 TCP/IP 协议之上工作，所以必须在所有客户端上安装 TCP/IP 协议。
     </para>
     
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFS 协议</term>
    <listitem>
     <para>
      CIFS（常用因特网文件系统）协议是 Samba 支持的另一种协议。CIFS 定义网络中使用的标准远程文件系统访问协议，使用户组能够一起工作并在网络中共享文档。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS</term>
    <listitem>
     <para>
       NetBIOS 是为用于提供名称服务的计算机之间进行通讯而设计的软件接口 (API)。它使连接到网络的计算机能够为自己保留名称。之后便可以根据名称对这些计算机进行寻址。没有任何中心进程来检查这些名称。网络上的任何计算机均可以保留所需数量的名称，前提是这些名称均未使用。可以为不同的网络体系结构实施 NetBIOS 接口。<phrase role="productname">NetBEUI</phrase> 是与网络硬件结合相对密切的一种实施，但它常被称为 <phrase role="productname">NetBIOS</phrase>。使用 NetBIOS 实施的网络协议包括 Novell 的 IPX（通过 TCP/IP 的 NetBIOS）和 TCP/IP。
     </para>
     <para>
      通过 TCP/IP 发送的 NetBIOS 名称与 <filename>/etc/hosts</filename> 中使用的名称或 DNS 定义的名称没有相同之处。NetBIOS 使用它自己的、完全独立的命名约定。但为了方便管理，建议您使用与 DNS 主机名对应的名称，或本机使用 DNS。Samba 默认采用这种方式。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba 服务器</term>
    <listitem>
     <para>
      Samba 服务器向客户端提供 SMB/CIFS 服务和 NetBIOS over IP 命名服务。对于 Linux，Samba 服务器有三个守护程序：smbd 用于 SMB/CIFS 服务，nmbd 用于命名服务，winbind 用于身份验证。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba 客户端</term>
    <listitem>
     <para>
      Samba 客户端是一种能够通过 SMB 协议从 Samba 服务器使用 Samba 服务的系统。常见操作系统（例如 Windows 和 macOS）都支持 SMB 协议。必须在所有计算机上安装 TCP/IP 协议。Samba 提供适用于多种不同类型 UNIX 的客户端。对于 Linux，有一个用于 SMB 的内核模块，它允许在 Linux 系统级别上集成 SMB 资源。不需要对 Samba 客户端运行任何守护程序。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>共享</term>
    <listitem>
     <para>
      SMB 服务器通过共享为其客户端提供资源。共享就是服务器上的打印机和目录及其子目录。可以通过名称来导出并访问共享。可以将共享名称设置为任何名称 — 不一定是导出目录的名称。也可以为打印机指派一个名称。客户端可通过打印机的名称访问打印机。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>
        域控制器 (DC) 是处理域中帐户的服务器。为了复制数据，一个域中可有更多域控制器可用。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-samba-server-sled" os="sled">
  <title>安装 Samba 服务器</title>
  <para>
   在 SUSE Linux Enterprise Desktop 上无法安装 Samba 服务器。有关安装和配置 Samba 服务器的信息，请参见《SUSE Linux Enterprise Server <citetitle>管理指南</citetitle>》。
  </para>
 </sect1>
 
 
 
 <sect1 xml:id="sec-samba-client-inst">
  <title>配置客户端</title>

  <para>
   客户端只能通过 TCP/IP 访问 Samba 服务器。NetBEUI 和通过 IPX 的 NetBIOS 不能与 Samba 共用。
  </para>

  <sect2 xml:id="sec-samba-client-inst-yast">
   <title>使用 YaST 配置 Samba 客户端</title>
   <para>
    配置 Samba 客户端来访问 Samba 或 Windows 服务器上的资源（文件或打印机）。在<menuchoice> <guimenu> 网络服务</guimenu>
    <guimenu> Windows 域成员资格</guimenu></menuchoice>对话框中输入 NT 或 Active Directory 域或工作组。如果激活<guimenu>将 SMB 信息也用于 Linux 身份验证</guimenu>，则用户身份验证将在 Samba、NT 或 Kerberos 服务器上运行。
   </para>
   <para>
    单击<guimenu>专家设置</guimenu>获取高级配置选项。例如，使用<guimenu>装入服务器目录</guimenu>表启用自动装入服务器用户主目录和身份验证。这样用户就能访问他们在 CIFS 上的主目录。有关细节，请参见 <systemitem>pam_mount</systemitem> 手册页。
   </para>
   <para>
    完成所有设置后，请确认对话框以完成配置。
   </para>
  </sect2>
  <sect2 xml:id="sec-samba-client-old-server">
   <title>在客户端上装入 SMB1 共享</title>
   <para>
    第一个 SMB 网络协议版本 SMB1 是一个不安全的早期协议，现已由其创始者 Microsoft 弃用。出于安全原因，<command>SUSE Linux Enterprise Desktop</command> 上的 <phrase role="productname"><phrase os="sled">mount</phrase></phrase> 命令默认只会使用较新的协议版本（即 SMB 2.1、SMB 3.0 或 SMB 3.02）装入 SMB 共享。
   </para>
   <para>
    但是，此项更改只会影响通过 <filename>/etc/fstab</filename> 执行的 <command>mount</command> 命令和装入操作。使用以下工具时，默认情况下 SMB1 仍然可用：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <command>smbclient</command> 工具。
     </para>
    </listitem>
    <listitem>
     <para>
      <phrase os="sles;sled">SUSE Linux Enterprise Server</phrase> 随附的 Samba 服务器软件。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    在以下设置中，由于只能使用 SMB1，此项默认设置会导致连接失败：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      使用不支持较新 SMB 协议版本的 SMB 服务器的设置。自 Windows 7 和 Windows Server 2008 开始，Windows 已推出 SMB 2.1 支持。
     </para>
    </listitem>
    <listitem>
     <para>
      依赖于 SMB1/CIFS 的 Unix 扩展的设置。这些扩展尚未移植到更高的协议版本。
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>降低系统安全性</title>
    <para>
     遵循以下指导可以解决安全问题。有关这些问题的详细信息，请参见 <link xlink:href="https://blogs.technet.microsoft.com/filecab/2016/09/16/stop-using-smb1/"/>。
    </para>
    <para>
     尽快升级服务器以使用更安全的 SMB 版本。
    </para>
    
   </important>
   <para>
    如果您需要在当前的 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 内核中启用 SMB1 共享，请将选项 <option>vers=1.0</option> 添加到所用的 <command>mount</command> 命令行中：
   </para>
   <screen><prompt role="root">root # </prompt>mount –t smbfs <replaceable>IP_ADDRESS</replaceable>:/<replaceable>SHARE</replaceable> /<replaceable>MOUNT_POINT</replaceable> –o username=<replaceable>USER_ID</replaceable>,workgroup=<replaceable>WORKGROUP_NAME</replaceable>,<emphasis role="bold">vers=1.0</emphasis></screen>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-anmeld-serv">
  <title>将 Samba 用作登录服务器</title>

  <para>
   在企业设置中，组织通常希望只允许已在中心实例上注册的用户进行访问。在基于 Windows 的网络中，此任务由主域控制器 (PDC) 来处理。您可以使用配置为 PDC 的 Windows NT 服务器，但是此任务也可以借助 Samba 服务器来完成。<xref linkend="dat-samba-smb-conf-dom"/>中显示了必须在 <filename>smb.conf</filename> 的 <literal>[global]</literal> 部分设置的项。
  </para>

  <example xml:id="dat-samba-smb-conf-dom">
   <title>smb.conf 中的 global 部分</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>
   需要准备适合 Windows 加密格式的用户帐户和口令。使用命令 <command>smbpasswd</command> <option>-a name </option>可完成此任务。使用以下命令为计算机创建 Windows 域概念要求的域帐户：
  </para>

<screen>useradd hostname
smbpasswd -a -m hostname</screen>

  <para>
   使用 <command>useradd</command> 命令可添加一个美元符号。命令 <command>smbpasswd</command> 在使用参数 <option>-m</option> 时自动插入此符号。带注释的配置示例 (<filename>/usr/share/doc/packages/samba/examples/smb.conf.SUSE</filename>) 包含自动执行此任务的设置。
  </para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m
     </screen>

  <para>
   要确保 Samba 能够正确执行此脚本，请选择具有必需的管理员权限的 Samba 用户，并将其添加到 <systemitem class="groupname">ntadmin</systemitem> 组中。然后可以使用以下命令为属于此 Linux 组的所有用户指派 <literal>Domain Admin</literal> 状态：
  </para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 
 <sect1 xml:id="sec-samba-advanced">
  <title>高级主题</title>

  <para>
   本节介绍用于管理 Samba 套件中客户端部分与服务器部分的高级方法。
  </para>

  <sect2 xml:id="sec-samba-advanced-compress">
   <title>Btrfs 上的透明文件压缩</title>
   <para>
    Samba 允许客户端针对 Btrfs 文件系统中的共享远程操作文件与目录压缩标志。Windows 资源管理器可让用户通过<menuchoice><guimenu>文件</guimenu><guimenu>属性</guimenu><guimenu>高级</guimenu></menuchoice>对话框来标记要进行透明压缩的文件/目录：
   </para>
   <figure>
    <title>Windows 资源管理器<guimenu>高级属性</guimenu>对话框</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    带有压缩标志的文件将以透明方式进行压缩，当用户访问或修改这些文件时，底层文件系统会将其解压缩。这通常可以节省储存容量，不过，在访问文件时会造成额外的 CPU 开销。除非新文件和目录是使用 FILE_NO_COMPRESSION 选项创建的，否则，它们将继承父目录的压缩标志。
   </para>
   <para>
    Windows 资源管理器以不同的显示方式区分压缩文件和未压缩文件：
   </para>
   <figure>
    <title>列有压缩文件的 Windows 资源管理器目录</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    要启用 Samba 共享压缩，您可以将以下内容
   </para>
<screen>vfs objects = btrfs</screen>
   <para>
    手动添加到 <filename>/etc/samba/smb.conf</filename> 中的共享配置，或者使用 YaST：<menuchoice><guimenu>网络服务</guimenu><guimenu>Samba 服务器</guimenu><guimenu>添加</guimenu></menuchoice>，然后选中<guimenu>使用 Btrfs 功能</guimenu>。
   </para>
   
  </sect2>

  <sect2 xml:id="sec-samba-advanced-snapshots">
   <title>快照</title>
   <para>
    快照也称为阴影副本，是指某个文件系统子卷在特定时间点的状态副本。在 Linux 中，可以使用 Snapper 工具来管理这些快照。Btrfs 文件系统或精简配置的 LVM 卷支持快照。Samba 套件支持通过服务器端和客户端的 FSRVP 协议管理远程快照。
   </para>
   <sect3 xml:id="sec-samba-advanced-snapshots-client">
    <title>先前版本</title>
    <para>
     Samba 服务器上的快照可以作为文件或目录的先前版本公开给远程 Windows 客户端。
    </para>
    <para>
     要在 Samba 服务器上启用快照，必须符合以下条件：
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       SMB 网络共享位于 Btrfs 子卷上。
      </para>
     </listitem>
     <listitem>
      <para>
       SMB 网络共享路径中包含相关的 snapper 配置文件。可以使用以下命令创建 snapper 文件
      </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> snapper -c &lt;cfg_name&gt; create-config <option>/path/to/share</option></screen>
      <para>
       有关 snapper 的更多信息，请参见<xref linkend="cha-snapper"/>。
      </para>
     </listitem>
     <listitem>
      <para>
       必须允许相关用户访问快照目录树。有关更多信息，请参见 vfs_snapper 手册页 (<command>man 8 vfs_snapper</command>) 的 PERMISSIONS（权限）部分。
      </para>
     </listitem>
    </itemizedlist>
    <para>
     要支持远程快照，需要修改 <filename>/etc/samba/smb.conf</filename> 文件。要完成此操作，您可以选择 <menuchoice><guimenu>YaST</guimenu><guimenu>网络服务</guimenu><guimenu>Samba 服务器</guimenu></menuchoice>，或者使用以下命令手动增强相关的共享部分
    </para>
<screen>vfs objects = snapper</screen>
    <para>
     请注意，只有在重启动 Samba 服务后，对 <filename>smb.conf</filename> 所做的手动更改才能生效：
    </para>
<screen><prompt>tux &gt; </prompt><command>sudo</command> systemctl restart nmb smb</screen>
    <figure xml:id="fig-yast2-samba-snapshot">
     <title>在启用快照的情况下添加新的 Samba 共享</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>
     经过配置后，可以通过 Windows 资源管理器中某个文件或目录的<guimenu>以前的版本</guimenu>选项卡访问 snapper 为 Samba 共享路径创建的快照。
    </para>
    <figure xml:id="fig-samba-win-explorer">
     <title>Windows 资源管理器中的<guimenu>以前的版本</guimenu>选项卡</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-server">
    <title>远程共享快照</title>
    <para>
     默认情况下，只能在 Samba 服务器本地通过 snapper 命令行实用程序或者使用 snapper 时间轴功能来创建和删除快照。
    </para>
    <para>
     可将 Samba 配置为使用文件服务器远程 VSS 协议 (FSRVP) 处理远程主机发出的共享快照创建和删除请求。
    </para>
    <para>
     除了<xref linkend="sec-samba-advanced-snapshots-client"/>中所述的配置和先决条件以外，还需要在 <filename>/etc/samba/smb.conf</filename> 中指定以下全局配置：
    </para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>
     然后，FSRVP 客户端（包括 Samba 的 <command>rpcclient</command> 以及 Windows Server 2012 <command>DiskShadow.exe</command>）便可以指示 Samba 为指定的共享创建或删除快照，并将该快照公开为新共享。
    </para>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-linux">
    <title>使用 <command>rpcclient</command> 从 Linux 远程管理快照</title>
    <para>
     <systemitem>samba-client</systemitem> 包中有一个 FSRVP 客户端，它可以远程请求 Windows/Samba 服务器创建并公开指定共享的快照。然后，您可以使用 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 中的现有工具装入公开的共享并备份其文件。向服务器发出的请求将使用 <command>rpcclient</command> 二进制文件发送。
    </para>
    <example>
     <title>使用 <command>rpcclient</command> 请求 Windows Server 2012 共享快照</title>
     <para>
      以 <literal>EXAMPLE</literal> 域中管理员的身份连接到 <literal>win-server.example.com</literal> 服务器：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para>
      检查 SMB 共享是否对于 <command>rpcclient</command> 可见：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>
      检查 SMB 共享是否支持创建快照：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>
      请求创建共享快照：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>
      确认服务器是否已公开快照共享：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>
      尝试删除快照共享：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>
      确认服务器是否已去除快照共享：
     </para>
<screen><prompt role="root">root # </prompt>rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-winserver">
    <title>使用 <command>DiskShadow.exe</command> 从 Windows 远程管理快照</title>
    <para>
     您也可以在充当客户端的 Windows 环境中，管理 Linux Samba 服务器上的 SMB 共享的快照。Windows Server 2012 提供了 <command>DiskShadow.exe</command> 实用程序，该程序可以像<xref linkend="sec-samba-advanced-snapshots-client-linux"/>中所述的 <command>rpcclient</command> 那样管理远程共享。请注意，首先您需要妥善设置 Samba 服务器。
    </para>
    <para>
     以下示例步骤描述了如何设置 Samba 服务器，使 Windows Server 客户端能够管理其共享的快照。请注意，<replaceable>EXAMPLE</replaceable> 是在测试环境中使用的 Active Directory 域，
     <uri>fsrvp-server.example.com</uri> 是 Samba 服务器的主机名，<filename>/srv/smb</filename> 是 SMB 共享的路径。
    </para>
    <procedure>
     <title>Samba 服务器配置详细说明</title>
     <step>
      <para>
       通过 YaST 加入到 Active Directory 域。
      </para>
     </step>
     <step>
      <para>
       确保“活动域 DNS”项正确：
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step>
      <para>
       在 <filename>/srv/smb</filename> 位置创建 Btrfs 子卷
      </para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step>
      <para>
       为路径 <filename>/srv/smb</filename> 创建 snapper 配置文件
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step>
      <para>
       创建路径为 <filename>/srv/smb</filename> 的新共享，并启用 YaST <guimenu>公开快照</guimenu>复选框。确保将以下代码片段添加到 <filename>/etc/samba/smb.conf</filename> 的 global 部分，如<xref linkend="sec-samba-advanced-snapshots-server"/>中所述：
      </para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step>
      <para>
       使用 <command>systemctl restart nmb smb</command> 重启动 Samba
      </para>
     </step>
     <step>
      <para>
       配置 snapper 权限：
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>
       确保也允许任何 ALLOW_USERS 浏览 <filename>.snapshots</filename> 子目录。
      </para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>路径转义</title>
       <para>
        请小心使用“\”转义！请转义两次，以确保 <filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename> 中储存的值转义一次。
       </para>
      </important>
      <para>
       "EXAMPLE\win-client$" 对应于 Windows 客户端计算机帐户。对此帐户进行验证后，Windows 将发出初始 FSRVP 请求。
      </para>
     </step>
     <step>
      <para>
       授予 Windows 客户端帐户必要的特权：
      </para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>
       不需要对 "EXAMPLE\Administrator" 用户执行上一条命令，因为已授予该用户特权。
      </para>
     </step>
    </procedure>
    <procedure>
     <title>运行 Windows 客户端设置和 <command>DiskShadow.exe</command></title>
     <step>
      <para>
       引导 Windows Server 2012（示例主机名为 WIN-CLIENT）。
      </para>
     </step>
     <step>
      <para>
       就像在 <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> 上那样，加入到同一个 Active Directory 域 EXAMPLE。
      </para>
     </step>
     <step>
      <para>
       重引导。
      </para>
     </step>
     <step>
      <para>
       打开 Powershell。
      </para>
     </step>
     <step>
      <para>
       启动 <command>DiskShadow.exe</command>，然后开始执行备份过程：
      </para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow version 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step>
      <para>
       指定每次程序退出、重设置或重引导时要保留的阴影副本：
      </para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step>
      <para>
       检查指定的共享是否支持快照，然后创建一个快照：
      </para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
Alias VSS_SHADOW_1 for shadow ID {de4ddca4-4978-4805-8776-cdf82d190a4a} set as \
 environment variable.
Alias VSS_SHADOW_SET for shadow set ID {c58e1452-c554-400e-a266-d11d5c837cb1} \
 set as environment variable.

Querying all shadow copies with the shadow copy set ID \
 {c58e1452-c554-400e-a266-d11d5c837cb1}

 * Shadow copy ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - Shadow copy set: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - Original count of shadow copies = 1
    - Original volume name: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [volume not on this machine]
    - Creation time: 6/17/2014 3:54:43 PM
    - Shadow copy device name:
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - Originating machine: FSRVP-SERVER
    - Service machine: win-client.example.com
    - Not exposed
    - Provider ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - Attributes:  No_Auto_Release Persistent FileShare

Number of shadow copies listed: 1</screen>
     </step>
     <step>
      <para>
       完成备份过程：
      </para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step>
      <para>
       创建快照后，尝试将它删除，并确认删除结果：
      </para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
Deleting shadow copy {de4ddca4-4978-4805-8776-cdf82d190a4a} on volume \
 \\FSRVP-SERVER\SLES_SNAPPER\ from provider \
{89300202-3cec-4981-9171-19f59559e0f2} [Attributes: 0x04000009]...

Number of shadow copies deleted: 1

DISKSHADOW&gt; list shadows all

Querying all shadow copies on the computer ...
No shadow copies found in system.</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-info">
  <title>更多信息</title>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>手册页：</title>
     <para>
      要查看连同包
      <package>samba</package>一起安装的所有手册页的列表，请运行 <command>apropos samba</command>。使用 <command>man <replaceable>手册页名称</replaceable></command>打开任一手册页。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>SUSE 特定的 README 文件：</title>
     <para>
      包 <package>samba-client</package> 包含文件 <filename>/usr/share/doc/packages/samba/README.SUSE</filename>。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>其他打包的文档：</title>
     <para>
      使用 <command>zypper install samba-doc</command> 安装 <systemitem>samba-doc</systemitem> 包。
     </para>
    </formalpara>
    <para>
     此文档将安装到 <filename>/usr/share/doc/packages/samba</filename> 中。其中包含手册页的 HTML 版本以及示例配置的库（例如 <filename>smb.conf.SUSE</filename>）。
    </para>
   </listitem>
   <listitem>
    <formalpara>
     <title>联机文档：</title>
     <para>
      <link xlink:href="https://wiki.samba.org/index.php/User_Documentation"/> 上的 Samba Wiki 包含丰富的<citetitle>用户文档</citetitle>。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
